---
title: "Sierra Nevada Fraction Analysis"
author: J. Beem-Miller
date: \textit{\today}
output:
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 3
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
  html_notebook:
    css: "custom.css"
    toc: yes
    toc_depth: 2
header_includes:
- \usepackage[utf8]{inputenc}
- \usepackage{float}
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = 'center', dev = c('cairo_pdf', 'png'), fig.width = 6.5,
                      fig.height = 3.5)
options(scipen = 5)
# load page breaks fx
source("./utilities/page_break_Rmd.R")
```

```{r setup, include = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(SoilR)
library(openxlsx)
library(ISRaD)
library(lme4)
library(lmerTest)
library(emmeans)
library(gt)
library(scales)
library(GSIF)
library(aqp)
```

```{r load raw-data-ingest fx}
source("./utilities/jena_ams_ingest.R")
source("./utilities/jena_iso_ingest.R")
source("./utilities/jena_elm_ingest.R")
```

```{r plot-funs}
# color palettes for ECO & PM
warm <- "#BF812D"
cool <- "#80CDC1"
cold <- "#01665E"
granite <- "#9daba9"
andesite <- "#382dbf"
basalt <- "#bf382d"
minC <- "#9b003f"
fPOM <- "#3f9b00"
oPOM <- "#0047af"
```

# Load data
## Internal 
### CN
#### Read raw

```{r load-cn-dat}
# 2001 & 2019 density fraction data
elm_results_dir <- list.files("../data/raw", pattern = "elm_jena_results", full.names = TRUE)
elm_results_ls <- lapply(seq_along(elm_results_dir), function(i) {
  if (grepl("elm_jena_results-soil", elm_results_dir[i])) {
    template_file <- "../data/raw/elm_jena_template/elm_jena_template2.xls"
  } else {
    template_file <- "../data/raw/elm_jena_template/elm_jena_template.xls"
  }
  read_jena_elm_results(elm_results_dir[i], template_file = template_file)
})
names(elm_results_ls) <- list.files("../data/raw", pattern = "elm_jena_results")

# separate bulkC from frcC
elm_results_blkC_ls <- elm_results_ls[which(grepl("elm_jena_results-soil", names(elm_results_ls)))]
elm_results_frcC_ls <- elm_results_ls[which(grepl("elm_jena_results-frc", names(elm_results_ls)))]

# extract bulk C and summarize
sra.blk.2019.df <- bind_rows(unlist(elm_results_blkC_ls, recursive = FALSE)) %>%
  mutate(PMeco = sapply(strsplit(ID, "_"), "[", 2),
         depth = sapply(strsplit(ID, "_"), "[", 4))
sra.blk.2019.sum.df <- sra.blk.2019.df %>%
  group_by(PMeco, depth) %>%
  summarize(across(c(C, N), .fns = list(mean = mean, sd = sd)), .groups = "drop") %>%
  mutate(ID2 = paste(PMeco, depth, sep = "_"))
```

#### Templates

```{r create-frc-data-templates}
## Create template for composite soil data (e.g. density fractions)
# Basic list template
PMeco.ls <- vector(mode = "list", length = 9)
names(PMeco.ls) <- levels(interaction(c("AN", "BS", "GR"), c("pp", "wf", "rf"), sep = ""))

# list of depths for 2001 samples
depth_bot_2001.ls <- list(ANpp = c(6, 13, 33),
                          ANwf = c(11, 35),
                          ANrf = c(11, 32),
                          BSpp = c(7, 18, 28),
                          BSwf = c(10, 19),
                          BSrf = c(8, 15, 30),
                          GRpp = c(7, 15, 27),
                          GRwf = c(4, 13, 28),
                          GRrf = c(8, 27))

# list of depths for 2019 samples
depth_bot_2019.ls <- lapply(PMeco.ls, function(df) seq(10, 30, 10))

# template fx
sra.frc.template.fx <- function(depth_bot, year) {
  nms <- names(depth_bot)
  ls <- lapply(seq_along(depth_bot), function(i) {
    n <- length(depth_bot[[i]])
    df <- data.frame(year = rep(year, n),
                     PM = rep(substr(nms[i], 1, 2), n), 
                     ECO = rep(substr(nms[i], 3, 4), n),
                     lyr_bot = depth_bot[[i]])
    df$lyr_top <- sapply(seq_along(depth_bot[[i]]), function(j) {
      if (j == 1) {
        0
      } else {
        depth_bot[[i]][j - 1]
      }
    })
    df$ID <- paste0(df$PM, df$ECO, "_comp_", df$year, "_", df$lyr_top, "-", df$lyr_bot)
    return(df)
  })
  names(ls) <- nms
  frc.ls <- replicate(3, ls, FALSE)
  names(frc.ls) <- c("FPOM", "OPOM", "MOM")
  return(frc.ls)
}

# 2001
sra.frc.tmp.2001.ls <- sra.frc.template.fx(depth_bot_2001.ls, 2001)

# 2019
sra.frc.tmp.2019.ls <- sra.frc.template.fx(depth_bot_2019.ls, 2019)
```

#### Merge raw w/ template

```{r fill-frc-cn}
# define extraction function
fill.cn.fx <- function(template, elm_results_ls, year, type) {
  
  # internal fx for extracting cn data and averaging analytical duplicates as needed
  extract.elm.fx <- function(ls) {
    lapply(ls, function(x) {
      ix <- grep(x$ID, cn.df$ID)
      if (length(ix > 1)) {
        x <- cbind(x,
                   C = mean(cn.df[ix, "C"]), 
                   N = mean(cn.df[ix, "N"]), 
                   row.names = NULL)
      } else if (length(ix) == 1) {
        x <- cbind(x, cn.df[ix, c("C", "N")], row.names = NULL)
      }
      return(x)
    })    
  }
  
  # select CN data by year
  cn.ls <- unlist(
    lapply(grep(paste0(type, substr(year, 3, 4)), names(elm_results_ls)), function(i) {
      elm_results_ls[[i]]
    }), recursive = FALSE)
  
  # store fraction names
  nms <- names(template)
  
  # loop for running extraction
  for(i in seq_along(nms)) {
    
    # make data frame of data for target fraction and year
    cn.df <- bind_rows(cn.ls[grep(names(template)[i], names(cn.ls))])
    
    # check if target fraction data exist and run extraction function if so
    if (nrow(cn.df) != 0) {
      
      # extract data for each fraction
      template[[i]] <- lapply(template[[i]], function(df) {
        bind_rows(extract.elm.fx(split(df, df$ID)))
      })
    }
  }
  
  # return output list named by target fraction
  names(template) <- nms
  return(template) 
}

# extract layer data by year
sra.frc.2001.ls <- fill.cn.fx(sra.frc.tmp.2001.ls, elm_results_frcC_ls, 2001, "frc")
sra.frc.2019.ls <- fill.cn.fx(sra.frc.tmp.2019.ls, elm_results_frcC_ls, 2019, "frc")
```

### 14C

```{r load-14c-dat}
# read ams dir
ams_jena_results_dirs <- list.files("../data/raw", pattern = "ams_jena_results", full.names = TRUE)

# list files w/ new and old templates by date
dates <- sapply(lapply(strsplit(ams_jena_results_dirs, "_(?!.*_)", perl = TRUE), "[[", 2), as.Date)
ams_jena_results_dirs_new <- ams_jena_results_dirs[which(dates > as.Date("2022-01-23"))]
ams_jena_results_dirs_old <- ams_jena_results_dirs[which(dates < as.Date("2022-01-23"))]

# new template
new_template <- "../data/raw/ams_jena_template_2022-01-24/ams_jena_template.xlsx"

# read in data
ams_results_ls <- c(
  lapply(seq_along(ams_jena_results_dirs_new), function(i) {
    read_jena_ams_results(ams_jena_results_dirs_new[i], 
                          template_file = new_template,
                          start = 31)
  }),
  lapply(seq_along(ams_jena_results_dirs_old), function(i) {
    read_jena_ams_results(ams_jena_results_dirs_old[i])
  }))
names(ams_results_ls) <- unlist(
  c(lapply(strsplit(ams_jena_results_dirs_new, "/(?!.*/)", perl = TRUE), "[[", 2),
    lapply(strsplit(ams_jena_results_dirs_old, "/(?!.*/)", perl = TRUE), "[[", 2)))

# remove flawed ANrf samples
ANrf.rm <- c("10_ANrf_comp_2019_0-10_MOM", 
             "11_ANrf_comp_2019_10-20_MOM_a",
             "12_ANrf_comp_2019_20-30_MOM")
if (any(!is.na(match(ANrf.rm, ams_results_ls$`ams_jena_results-frc19-MOM_2021-06-26`$`Beem-Miller_24.xlsx`$Probe)))) {
  ams_results_ls$`ams_jena_results-frc19-MOM_2021-06-26`$`Beem-Miller_24.xlsx` <- ams_results_ls$`ams_jena_results-frc19-MOM_2021-06-26`$`Beem-Miller_24.xlsx`[-match(ANrf.rm, ams_results_ls$`ams_jena_results-frc19-MOM_2021-06-26`$`Beem-Miller_24.xlsx`$Probe), ]
}

# # separate redos
# ams_results_redo_ls <- lapply(ams_results_ls, function(ls)
#     Filter(Negate(is.null), lapply(ls, function(df) {
#       df_R <- df[grep("_R", df$Probe), ] 
#       if (nrow(df_R) != 0) {
#         df_R
#       }
#     })))
# ams_results_redo_df <- bind_rows(Filter(
#     Negate(is.null), lapply(ams_results_redo_ls, function(ls) {
#       if (length(ls) > 0) {
#         bind_rows(ls)
#       }
#     }))) %>%
#   filter(!is.na(F14C))
```

### Mass

```{r load-frc-mass-data}
# load raw data
sra.frc.mss.raw <- read_excel("../data/raw/lab_jena_results-frc19-frc01_2021-05-05/Dichtefraktionierung_Jeff_2020.xls", sheet = "Tabelle1")

# filter and reduce
sra.frc.mss.df <- sra.frc.mss.raw %>%
  filter(is.na(SampleRedone)) %>%
  select(Probe, `Einwaage (g)`, Fraktion, `LF (g)`, `HF (g)`) %>%
  mutate(yield = ifelse(is.na(`LF (g)`), `HF (g)`, `LF (g)`)) %>%
  select(-c(`LF (g)`, `HF (g)`)) %>%
  rename(wt_g = `Einwaage (g)`)

# 1) combine multiple flask samples for individual flasks
# 2) fill in missing oPOM data from 2019 GRrf sites
# NB: almost no loss for 2001 sites, so seems justified to assume none in 2019
sra.frc.mss.wide.df <- bind_rows(
  lapply(split(sra.frc.mss.df, sra.frc.mss.df$Probe), function(df) {
    if (nrow(df) > 3) {
      df <- df %>% 
        group_by(Fraktion, Probe, wt_g) %>%
        summarize(yield = sum(yield), .groups = "drop")
    }
    return(df)
  })) %>%
  pivot_wider(names_from = Fraktion, values_from = yield) %>%
  rename(FPOM = fPOM, OPOM = oPOM, MOM = HF) %>%
  mutate(OPOM = ifelse(is.na(OPOM), wt_g - FPOM - MOM, OPOM))

# sum mass
sra.frc.mss.wide.df$mass_sum <- rowSums(sra.frc.mss.wide.df[ , c("FPOM", "OPOM", "MOM")])

# pivot longer and calculate mass pct
sra.frc.mss.long.df <- sra.frc.mss.wide.df %>%
  pivot_longer(cols = c("FPOM", "OPOM", "MOM"), names_to = "frc", values_to = "mass_g") %>%
  mutate(mass_pct = round(mass_g / mass_sum * 100, 1),
         depth = sapply(strsplit(Probe, "_(?!.*_)", perl = TRUE), "[[", 2),
         lyr_top = as.numeric(sapply(strsplit(depth, "[-]"), "[[", 1)),
         lyr_bot = as.numeric(sapply(strsplit(depth, "[-]"), "[[", 2)),
         year = as.numeric(sapply(strsplit(Probe, "_"), "[[", 3)),
         PMeco = sapply(strsplit(Probe, "_"), "[[", 1)) %>%
  arrange(lyr_bot)

# split by year
sra.frc.mss.long.01.df <- sra.frc.mss.long.df[sra.frc.mss.long.df$year == 2001, ]
sra.frc.mss.long.19.df <- sra.frc.mss.long.df[sra.frc.mss.long.df$year == 2019, ]
```


```{r plot-frc-mass-losses}
# calc loss, drop samples without all weights
sra.frc.mss.lss.df <- sra.frc.mss.wide.df
sra.frc.mss.lss.df$sum <- rowSums(sra.frc.mss.lss.df[ , c("FPOM", "OPOM", "MOM")])
sra.frc.mss.lss.df$loss <- sra.frc.mss.lss.df$wt_g - sra.frc.mss.lss.df$sum
sra.frc.mss.lss.df$loss_pct <- (sra.frc.mss.lss.df$loss / sra.frc.mss.lss.df$wt_g) * 100
  
# summarize losses by PM, ECO
sra.frc.mss.lss.df$PM <- substr(sra.frc.mss.lss.df$Probe, 1, 2)
sra.frc.mss.lss.df$ECO <- factor(substr(sra.frc.mss.lss.df$Probe, 3, 4), 
                                 levels = c("pp", "wf", "rf"))
sra.frc.mss.lss.df$year <- as.numeric(substr(sra.frc.mss.lss.df$Probe, 11, 14))
sra.frc.mss.lss.df$depth <- sapply(
  strsplit(sra.frc.mss.lss.df$Probe, "_(?!.*_)", perl = TRUE), 
  "[[", 2)
sra.frc.mss.lss.df$lyr_bot <- as.numeric(ifelse(nchar(sra.frc.mss.lss.df$depth) == 3, substr(sra.frc.mss.lss.df$depth, 3, 3), ifelse(nchar(sra.frc.mss.lss.df$depth) == 4, substr(sra.frc.mss.lss.df$depth, 3, 4), substr(sra.frc.mss.lss.df$depth, 4, 5))))

## summarize
# summary(lm(loss_pct ~ PM + ECO + year + lyr_bot, 
#            sra.frc.mss.lss.df[-which(sra.frc.mss.lss.df$Probe == "BSpp_comp_2001_18-28"), ]))
summary(lm(loss_pct ~ PM + ECO, 
           sra.frc.mss.lss.df[-which(sra.frc.mss.lss.df$Probe == "BSpp_comp_2001_18-28"), ]))

# plot
sra.frc.mss.lss.df %>%
  rename(`Mass loss (%)` = loss_pct) %>%
  mutate(eco = factor(ifelse(ECO == "pp", "warm",
                             ifelse(ECO == "wf", "cool", "cold")),
                      levels = c("warm", "cool", "cold")),
         pm = ifelse(PM == "AN", "andesite",
                     ifelse(PM == "BS", "basalt", "granite"))) %>%
  ggplot(., aes(ECO, `Mass loss (%)`, color = pm, shape = eco)) +
  geom_hline(yintercept = 0, color = "black") +
  geom_point(size = 3) +
  scale_color_manual(values = c("andesite" = andesite,
                                "basalt" = basalt,
                                "granite" = granite)) +
  scale_shape_manual(values = c("warm" = 15,
                                "cool" = 17,
                                "cold" = 16)) +
  facet_grid(cols = vars(year)) +
  theme_bw() +
  theme(panel.grid = element_blank())
```

Interestingly, it appears that AN soils have proportionally LESS minC by mass than do GR or BS soils, significantly so at depth. Why would this be? Possibly because AN soils have higher losses (DOC) during fractionation?

## External data
### Atmosphere

```{r atm14c-data}
Datm <- rbind(graven, future14C)
atm.14c <- data.frame(year = Datm[Datm$Date > 2000, "Date"],
                      d14c = Datm[Datm$Date > 2000, "NHc14"],
                      Type = "atmosphere")
```

### from C. Rasmussen ('01 C, N; '09 14C, frc mass, C, N)

```{r load-ras-01-09-data}
# Rasmussen 2001 data
## 2001 summary data
soc.2001 <- data.frame(read_excel("../data/external/sra_ras_sum/sierra_data_summary_2020.xlsx",
                                  sheet = "2001_bulk_data"))

# Rasmussen 2009 data
## 2009 fraction C, N, mass data
sra.09.frc.raw <- read_excel("../data/external/sra_ras_sum/sierra_data_summary_2020.xlsx", sheet = "2009_fraction_data") %>% type.convert(., as.is = TRUE) %>% data.frame

## 2009 summary data
sra.09.sum <- read_excel("../data/external/sra_ras_sum/sierra_data_summary_2020.xlsx", sheet = "Data_Summary_2018_paper") %>% type.convert(., as.is = TRUE) %>% data.frame

## 2009 bulk C
soc.09.blkC.df <- read_excel("../data/external/sra_ras_sum/sierra_data_summary_2020.xlsx", sheet = "2009_bulk_data") %>% type.convert(., as.is = TRUE) %>% data.frame

# Rasmussen 2009 14C data: ISRaD
## read ISRaD fx
sra.09.israd <- ISRaD.read.entry("../data/external/sra_ras_ISRaD/Rasmussen_2018.xlsx")

# get lyr data
sra.09.lyr.df <- sra.09.israd$Rasmussen_2018$layer

# get frc data
sra.09.frc.df <- merge(
  sra.09.israd$Rasmussen_2018$fraction,
  sra.09.israd$Rasmussen_2018$layer[, c("pro_name", "lyr_name", "lyr_bot", "lyr_top", "lyr_c_org", "lyr_n_tot", "lyr_soc", "lyr_bd_samp", "lyr_obs_date_y")], by = c("pro_name", "lyr_name"))

## fill missing d14c data
ix <- which(is.na(sra.09.frc.df$frc_14c) & !is.na(sra.09.frc.df$frc_fraction_modern))
sra.09.frc.df[ix, "frc_14c"] <- convert_fm_d14c(
  fm = sra.09.frc.df[ix, "frc_fraction_modern"], 
  obs_date_y = sra.09.frc.df[ix, "lyr_obs_date_y"])

## reshape ISRaD data to merge with dens.df
sra.frc.14c <- sra.09.frc.df %>%
  mutate(PMeco = as.character(pro_name),
         PM = substr(PMeco, 1, 2),
         ECO = substr(PMeco, 3, 4),
         pro_name = paste0(PMeco, "_", lyr_obs_date_y),
         frc = ifelse(frc_property == "free light", "fPOM", 
                      ifelse(frc_property == "heavy", "minC", "oPOM")),
         Year = 2009) %>% # note that GR samples were technically collected in 2010...
  select(frc_fraction_modern, frc_fraction_modern_sigma, frc_14c, frc_14c_sigma, frc, PMeco, PM, ECO, Year, pro_name, lyr_top, lyr_bot, lyr_bd_samp) %>% 
  rename(F14C = frc_fraction_modern,
         err = frc_fraction_modern_sigma,
         frc_14c_err = frc_14c_sigma) 
```

# Analysis
## Misc. functions

```{r define-C-spline-fxs}
# depth spline for C percent, where d = vector of layer bottom depths
Cspline.fx <- function(df, var.name, d = c(10, 20, 30)) {
  bind_rows(lapply(split(df, df$pro_name), function(x) {
    depths(x) <- pro_name ~ lyr_top + lyr_bot
    x.mps <- mpspline(x, var.name = var.name, d = t(c(0, d)))
    x.std <- t(x.mps$var.std)
    df <- data.frame(c_pct = x.std, depth = row.names(x.std))
    df$depth <- gsub(" [^ ]*$", "", df$depth)
    return(df[1:length(d), ])
  }), .id = "pro_name")
}

# depth spline for monotonic cumulative C stocks; NB: input must be 2-col df w/ depth (1) and cmtv SOC (2)
SOCspline.fx <- function(x, depths, soc) {
  t0 <- data.frame(lyr_bot = 0)
  t0[[soc]] <- 0
  t0.x <- rbind(t0, x)
  
  # fit monotonic cubic spline
  sp <- spline(t0.x, method = "hyman") 
  
  # convert to class "spline" with smooth.spline fxn
  sp.ss <- smooth.spline(sp, all.knots = TRUE) 
  max.d <- max(x[ , 1])
  if (max.d < 31) {
    max.d <- 31
  }
  
  # predict at given depths (linear beyond last measured depth)
  spp <- predict(sp.ss, depths) 
  df <- data.frame(spp)
  colnames(df) <- c("lyr_bot", "lyr_soc") 
  
  # calculate soc per increment from cmtv values
  for(i in seq_along(df$lyr_bot)) {
    if(i == 1) {
      df$lyr_soc[i] <- df$lyr_soc[i]
    } else {
      df$lyr_soc[i] <- df$lyr_soc[i + 1] - df$lyr_soc[i]
    }
  }
  
  # return 
  df$lyr_bot <- df$lyr_bot + 1
  return(df[-length(df$lyr_soc), ])
}
```

## Bulk C
### 2001
```{r blkc-data-2001}
# Fraction samples combined 0-3 and 3-8 depth increments for BSrf and GRrf
## function for calculating depth-weighted average of first two depth increment C content
d1d2.fx <- function(df) {
  d1d2 <- data.frame(ID = paste(df$PMeco[1], df$pro_rep[1], df$lyr_top[1], df$lyr_bot[2], sep = "_"),
                     PMeco = df$PMeco[1],
                     mass_kgm2 = sum(df$mass_kgm2[1], df$mass_kgm2[2]),
                     c_pct = sum(df$c_pct[1] * ((df$lyr_bot[1] - df$lyr_top[1]) / df$lyr_bot[2]),
                                 df$c_pct[2] * ((df$lyr_bot[2] - df$lyr_top[2]) / df$lyr_bot[2])),
                     lyr_soc_kgm2 = sum(df$lyr_soc_kgm2[1], df$lyr_soc_kgm2[2]),
                     pro_name = df$pro_name[1],
                     lyr_top = df$lyr_top[1],
                     lyr_bot = df$lyr_bot[2])
  return(rbind(d1d2,
               df[3:nrow(df), ]))
}

# Create list
soc.2001.ls <- lapply(split(soc.2001, soc.2001$PMeco), function(df) {
  
  # remove NAs
  df <- type.convert(df[complete.cases(df), ])
  
  # filter < 36cm, rename c_pct, add mass and soc stock columns
  df <- df %>%
    filter(lyr_bot < 36) %>%
    rename(c_pct = C.) %>%
    mutate(mass_kgm2 = bd.g.cm3 * (lyr_bot - lyr_top) * fine.earth. * .1,
           lyr_soc_kgm2 = mass_kgm2 * c_pct * 10^-2,
           pro_name = paste(PMeco, pro_rep, sep = "_")) %>%
    select(ID, PMeco, mass_kgm2, c_pct, lyr_soc_kgm2, pro_name, lyr_top, lyr_bot)
  
  # combine 0-3, 3-8 cm depths for GRrf, BSrf
  if (df$PMeco[1] == "GRrf" | df$PMeco[1] == "BSrf") {
    df<- bind_rows(lapply(split(df, df$pro_name), d1d2.fx))
  }

  # calculate cmtv soc stocks
  ls <- split(df, df$pro_name)
  ls <- lapply(ls, function(x) {
    x <- x[order(x$lyr_bot), ] # make sure to order data
    x$lyr_soc_cmtv <- NA
    for(i in seq_along(x$lyr_bot)) {
      if(i == 1) {
        x$lyr_soc_cmtv[i] <- x$lyr_soc_kgm2[i]
      } else {
        x$lyr_soc_cmtv[i] <- x$lyr_soc_kgm2[i] + x$lyr_soc_cmtv[i-1] 
      }
    }
    return(x)
  })
  return(unsplit(ls, df$pro_name))
})

# summarize
soc.2001.sum.df <- bind_rows(soc.2001.ls) %>%
  group_by(PMeco, lyr_top, lyr_bot) %>%
  summarize(across(c(mass_kgm2, c_pct, lyr_soc_kgm2, lyr_soc_cmtv), 
            .fns = list(mean = mean, sd = sd)), .groups = "drop") %>%
  mutate(ID2 = paste0(PMeco, "_", lyr_top, "-", lyr_bot))
```

### 2009
```{r c-data-2009}
# calculate cumulative soc stocks for '09 data
sra.09.lyr.C <- unsplit(lapply(
  split(sra.09.frc.df, sra.09.frc.df$pro_name), function(x) {
    x <- x[order(x$lyr_bot), ] # make sure to order data
    x$lyr_soc_kgm2 <- x$lyr_soc * 10
    x$lyr_soc_cmtv <- NA
    for(i in seq_along(x$lyr_bot)) {
      if(i == 1) {
        x$lyr_soc_cmtv[i] <- x$lyr_soc_kgm2[i]
      } else {
        x$lyr_soc_cmtv[i] <- x$lyr_soc_kgm2[i] + x$lyr_soc_cmtv[i-1] 
      }
    }
    return(x)
  }), sra.09.frc.df$pro_name) %>%
  rename(PMeco = pro_name,
         frc_c_pct = frc_c_perc) %>%
  mutate(frc = ifelse(frc_property == "free light", "FPOM", 
                      ifelse(frc_property == "heavy", "MOM", "OPOM")),
         PM = substr(PMeco, 1, 2),
         ECO = factor(substr(PMeco, 3, 4), levels = c("pp", "wf", "rf")),
         mass_c_g = lyr_soc_kgm2 * frc_c_pct * 10^-2)
```

### 2019

```{r load-2019-soc}
load("sra.19.blkC.RData")
sra.soc.2019.df <- sra.19.blkC %>%
  filter(lyr_bot < 31) %>%
  group_by(PMeco, lyr_bot) %>%
  summarize(c_pct_lyr = mean(C), .groups = "drop") %>%
  mutate(PM = substr(PMeco, 1, 2),
         ECO = substr(PMeco, 3, 4))
```

## Fraction C
### C, CN profiles

```{r plot-c-n-cn}
# plot depth profiles
# plot fx
frc.pro.plot <- function(df, year, fraction, x) {
  quo_x <- sym(x)
  xlab <- ifelse(x == "CN", "CN", paste(x, "(%)"))
  df$ECO <- factor(df$ECO, levels = c("pp", "wf", "rf"))
  df <- df[order(df$lyr_bot), ]
  df$middepth <- df$lyr_top + (df$lyr_bot - df$lyr_top) / 2
  ggplot(df, aes(!! quo_x, middepth, color = PM, shape = ECO)) +
    geom_hline(yintercept = 0) +
    geom_point(size = 3) +
    geom_path() +
    scale_y_reverse(limits = c(30, 0)) +
    scale_x_continuous() +
    scale_color_manual(name = "Parent material",
                       labels = c("AN" = "andesite",
                                  "BS" = "basalt",
                                  "GR" = "granite"),
                       values = c("AN" = andesite, 
                                  "BS" = basalt, 
                                  "GR" = granite)) +
    scale_shape_manual(name = "Climate",
                       labels = c("pp" = "warm",
                                  "rf" = "cold",
                                  "wf" = "cool"),
                       values = c("pp" = 15, 
                                  "rf" = 16, 
                                  "wf" = 17)) +
    xlab(xlab) +
    ylab("Depth (cm)") +
    ggtitle(paste(year, fraction)) +
    theme_bw() +
    theme(panel.grid.minor = element_blank())
}

# Combine profiles for plotting
frc.C.01.plot.ls <- lapply(sra.frc.2001.ls, bind_rows, .id = "fraction")
lapply(seq_along(frc.C.01.plot.ls), function(i) {
  frc.pro.plot(frc.C.01.plot.ls[[i]], 2001, names(frc.C.01.plot.ls)[i], "C")
})

frc.C.19.plot.ls <- lapply(sra.frc.2019.ls, bind_rows, .id = "fraction")
lapply(seq_along(frc.C.19.plot.ls), function(i) {
  frc.pro.plot(frc.C.19.plot.ls[[i]], 2019, names(frc.C.19.plot.ls)[i], "C")
})

# Calculate and plot CN
lapply(seq_along(frc.C.01.plot.ls), function(i) {
  frc.C.01.plot.ls[[i]][["CN"]] <- frc.C.01.plot.ls[[i]][["C"]] / frc.C.01.plot.ls[[i]][["N"]]
  frc.pro.plot(frc.C.01.plot.ls[[i]], 2001, names(frc.C.01.plot.ls)[i], "CN")
})
lapply(seq_along(frc.C.19.plot.ls), function(i) {
  frc.C.19.plot.ls[[i]][["CN"]] <- frc.C.19.plot.ls[[i]][["C"]] / frc.C.19.plot.ls[[i]][["N"]]
  frc.pro.plot(frc.C.19.plot.ls[[i]], 2019, names(frc.C.19.plot.ls)[i], "CN")
})
```

```{r merge-frc-mass-C}
## merge C and mass data
# '01
sra.frc.mss.C.01.df <- merge(
  bind_rows(
    lapply(sra.frc.2001.ls, function(ls) bind_rows(ls, .id = "PMeco")), .id = "frc"),
  sra.frc.mss.long.01.df, by = c("year", "PMeco", "lyr_bot", "lyr_top", "frc")) %>% 
  mutate(ID2 = sub("comp_2001_", x = ID, replacement = ""))

# calculate C weights
sra.frc.mss.C.01.df$mass_c_g <- sra.frc.mss.C.01.df$mass_sum * (sra.frc.mss.C.01.df$mass_pct / 100) * (sra.frc.mss.C.01.df$C / 100)

# calc synthetic lyr_c (as sum of frc c masses) and percent
if (!("lyr_c_mass_syn" %in% names(sra.frc.mss.C.01.df))) {
  sra.frc.mss.C.01.df <- sra.frc.mss.C.01.df %>%
    group_by(year, PMeco, lyr_bot) %>%
    summarize(lyr_c_mass_syn = sum(mass_c_g), .groups = "drop") %>%
    right_join(., sra.frc.mss.C.01.df, by = c("year", "PMeco", "lyr_bot"))
}
sra.frc.mss.C.01.df$frc_c_pct <- sra.frc.mss.C.01.df$mass_c_g / sra.frc.mss.C.01.df$lyr_c_mass_syn

# add lyr C
sra.frc.mss.C.01.df$lyr_c_pct <- unlist(soc.2001.sum.df[
  match(sra.frc.mss.C.01.df$ID2, soc.2001.sum.df$ID2), "c_pct_mean"])

# relevel fraction factor
sra.frc.mss.C.01.df$frc <- factor(sra.frc.mss.C.01.df$frc, 
                                  levels = c("FPOM", "OPOM", "MOM"))

# convert to data.frame
sra.frc.mss.C.01.df <- data.frame(sra.frc.mss.C.01.df)

# add middepth
sra.frc.mss.C.01.df$middepth <- sra.frc.mss.C.01.df$lyr_top +
  (sra.frc.mss.C.01.df$lyr_bot - sra.frc.mss.C.01.df$lyr_top) / 2

## '19
sra.frc.mss.C.19.df <- merge(
  bind_rows(
    lapply(sra.frc.2019.ls, function(ls) bind_rows(ls, .id = "PMeco")), .id = "frc"),
  sra.frc.mss.long.19.df, by = c("year", "PMeco", "lyr_bot", "lyr_top", "frc")) %>% 
  mutate(ID2 = sub("comp_2019_", x = ID, replacement = ""))

# calculate C weights
sra.frc.mss.C.19.df$mass_c_g <- sra.frc.mss.C.19.df$mass_sum *(sra.frc.mss.C.19.df$mass_pct / 100) * (sra.frc.mss.C.19.df$C / 100)

# add lyr C
sra.frc.mss.C.19.df$lyr_c_pct <- unlist(sra.blk.2019.sum.df[
  match(sra.frc.mss.C.19.df$ID2, sra.blk.2019.sum.df$ID2), "C_mean"])

# calc synthetic lyr_c (as sum of frc c masses) and percent
if (!("lyr_c_mass_syn" %in% names(sra.frc.mss.C.19.df))) {
  sra.frc.mss.C.19.df <- sra.frc.mss.C.19.df %>%
    group_by(year, PMeco, lyr_bot) %>%
    summarize(lyr_c_mass_syn = sum(mass_c_g), .groups = "drop") %>%
    right_join(., sra.frc.mss.C.19.df, by = c("year", "PMeco", "lyr_bot"))
}
sra.frc.mss.C.19.df$frc_c_pct <- sra.frc.mss.C.19.df$mass_c_g / sra.frc.mss.C.19.df$lyr_c_mass_syn
sra.frc.mss.C.19.df$ECO <- factor(sra.frc.mss.C.19.df$ECO, levels = c("pp", "wf", "rf"))
```

### C stocks
```{r frc-c-stocks}
# load soc stock data
# calculate fraction stocks
```


### C distribution

```{r plot-frcC-pct-fx}
# box plot fx
frc_c_pct.plot.fx <- function(df, fill_var) {
  
  # set fill variable and guides
  quo_fill_var <- sym(fill_var)
  if (fill_var == "PM") {
    fill_vals <- c("AN" = andesite, "BS" = basalt, "GR" = granite)
  } else {
    fill_vals <- c("pp" = warm, "wf" = cool, "rf" = cold)
  }
  
  # plot
 df %>%
  mutate(frc = factor(frc, levels = c("FPOM", "OPOM", "MOM"))) %>%
  ggplot(., aes(frc, frc_c_pct)) +
  geom_boxplot(aes(fill = !! quo_fill_var), position = "dodge") +
  scale_fill_manual(name = NULL,
                    values = fill_vals) +
  facet_grid(cols = vars(depth)) +
  ylab("C partitioning (%)") +
  xlab(NULL) +
  theme_bw() +
  theme(panel.grid = element_blank()) 
}
```

```{r plot-frcC-pct-01}
# 2001
## prep fx
sra.frc.mss.C.01.prep.fx <- function(df) {
  bind_rows(
    lapply(split(df, df$PMeco), function(d) {
      bind_rows(lapply(split(d, d$frc), function(f) {
        f <- f[order(f$lyr_bot), ]
        f$depth <- seq(1, nrow(f))
        return(f)
      }))
    }))
}

## PM
frc_c_pct.plot.fx(sra.frc.mss.C.01.prep.fx(sra.frc.mss.C.01.df), 
                  fill_var = "PM")

## ECO
frc_c_pct.plot.fx(sra.frc.mss.C.01.prep.fx(sra.frc.mss.C.01.df), 
                  fill_var = "ECO")
```

```{r plot-frcC-pct-09}
# 2009
frc_c_pct.plot.fx(sra.frc.mss.C.01.prep.fx(sra.09.lyr.C), "PM")
frc_c_pct.plot.fx(sra.frc.mss.C.01.prep.fx(sra.09.lyr.C), "ECO")
```

```{r plot-frcC-pct-19}
# 2019
frc_c_pct.plot.fx(sra.frc.mss.C.19.df, "PM")
frc_c_pct.plot.fx(sra.frc.mss.C.19.df, "ECO")
```

```{r c-dist-pm-eco}
sra.frc.mss.C.19.df %>%
  mutate(c_mass_wt = mass_c_g / sum(mass_c_g),
         eco = factor(ifelse(ECO == "pp", "WARM",
                             ifelse(ECO == "wf", "COOL", "COLD")),
                      levels = c("WARM", "COOL", "COLD")),
         pm = ifelse(PM == "AN", "andesite",
                     ifelse(PM == "BS", "basalt", "granite"))) %>%
  group_by(pm, eco, frc) %>%
  summarize(frc_c_pct_30 = round(weighted.mean(frc_c_pct, c_mass_wt) * 100, 0),
            .groups = "drop") %>%
  mutate(frc = factor(frc, levels = c("FPOM", "MOM", "OPOM"),
                      labels = c("free light", "heavy", "occluded light"))) %>%
  ggplot(., aes(pm, frc_c_pct_30)) +
  geom_col(aes(fill = pm), position = "dodge") +
  scale_fill_manual(name = NULL,
                    values = c("andesite" = andesite, 
                               "basalt" = basalt, 
                               "granite" = granite)) +
  facet_grid(cols = vars(eco), rows = vars(frc)) +
  ylab("C partitioning (%)") +
  xlab(NULL) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 10),
        strip.text.x = element_text(face = "bold", size = 12),
        strip.text.y = element_text(face = "bold", angle = 0, size = 12),
        strip.background = element_rect(fill = "white", color = "white"),
        legend.position = "bottom",
        legend.text = element_text(size = 12)) 
```

```{r calc-frc-C-distr-err}
# make wide dataframe for 2019 frc data
merge.vars <- c("year", "PM", "ECO", "lyr_bot")
sra.frc.2019.df <- merge(
  merge(bind_rows(sra.frc.2019.ls$FPOM)[, c(merge.vars, "C", "N")],
        bind_rows(sra.frc.2019.ls$OPOM)[, c(merge.vars, "C", "N")],
        by = merge.vars, suffixes = c("_fPOM", "_oPOM")),
  bind_rows(sra.frc.2019.ls$MOM)[, c(merge.vars, "C", "N")], by = merge.vars) %>%
  rename(C_minC = C, N_minC = N)

# fill missing oPOM data
sra.frc.mss.wide.fill.df <- sra.frc.mss.lss.df
sra.frc.mss.wide.fill.df$oPOM <- ifelse(
  is.na(sra.frc.mss.wide.df$OPOM),
  sra.frc.mss.wide.df$wt_g - (sra.frc.mss.wide.df$FPOM + sra.frc.mss.wide.df$MOM),
  sra.frc.mss.wide.df$OPOM)

# calculate mass precentages
sra.frc.mss.wide.fill.df <- sra.frc.mss.wide.fill.df %>%
  mutate(fPOM_mass_frac = FPOM / wt_g,
         oPOM_mass_frac = OPOM / wt_g,
         minC_mass_frac = MOM / wt_g,
         PMeco = paste0(PM, ECO))

# # model
# summary(lm(fPOM_mass_frac ~ PM + ECO, 
#            sra.frc.mss.wide.fill.df[sra.frc.mss.wide.fill.df$lyr_bot == 10 & sra.frc.mss.wide.fill.df$year == 2019,]))
# summary(lm(oPOM_mass_frac ~ PM + ECO, 
#            sra.frc.mss.wide.fill.df[sra.frc.mss.wide.fill.df$lyr_bot == 10 & sra.frc.mss.wide.fill.df$year == 2019,]))
# summary(lm(minC_mass_frac ~ PM + ECO, 
#            sra.frc.mss.wide.fill.df[sra.frc.mss.wide.fill.df$lyr_bot == 10 & sra.frc.mss.wide.fill.df$year == 2019,]))

# plot
sra.frc.mss.fill.plot.df <- sra.frc.mss.wide.fill.df %>%
  pivot_longer(cols = contains("mass_frac"), names_to = "Fraction", values_to = "Mass percent") %>%
  mutate(Fraction = factor(Fraction,
                           levels = c("fPOM_mass_frac", "oPOM_mass_frac", "minC_mass_frac"),
                           labels = c("fPOM_mass_frac" = "fPOM",
                                      "oPOM_mass_frac" = "oPOM", 
                                      "minC_mass_frac" = "minC")))

# 2019
sra.frc.mss.fill.plot.df %>%
  filter(year == 2019) %>%
  ggplot(., aes(PMeco, `Mass percent`, fill = Fraction)) +
  geom_hline(yintercept = 1, color = "black") +
  geom_col() +
  facet_grid(rows = vars(depth)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank())

# 2001 too hard to plot with all depths
sra.frc.mss.fill.plot.df %>%
  filter(year == 2001) %>%
  group_by(PMeco, Fraction) %>%
  summarize(`Mass percent` = mean(`Mass percent`)) %>%
  ggplot(., aes(PMeco, `Mass percent`, fill = Fraction)) +
  geom_hline(yintercept = 1, color = "black") +
  geom_col() +
  theme_bw() +
  theme(panel.grid.minor = element_blank())

# merge w/ frc lists
sra.frc.soc.2001.ls <- lapply(lapply(sra.frc.2001.ls, bind_rows), function(df) {
  merge(df, 
        soc.2001.sum.df %>%
          mutate(PM = substr(PMeco, 1, 2),
                 ECO = substr(PMeco, 3, 4)) %>%
          select(PM, ECO, lyr_bot, lyr_top, c_pct_mean, lyr_soc_kgm2_mean) %>%
          rename(c_pct_lyr = c_pct_mean,
                 lyr_soc = lyr_soc_kgm2_mean), 
        by = c("PM", "ECO", "lyr_bot", "lyr_top")) %>%
    select(-c("ID", "lyr_soc")) %>%
    mutate(year = 2001)
})
sra.frc.soc.2019.ls <- lapply(lapply(sra.frc.2019.ls, bind_rows), function(df) {
  merge(df, sra.soc.2019.df, by = c("PM", "ECO", "lyr_bot")) %>%
    select(-c("ID", "PMeco"))
})

# merge 01, 19
sra.frc.soc.01.19.ls <- lapply(seq_along(sra.frc.soc.2019.ls), function(i) {
  rbind(sra.frc.soc.2019.ls[[i]], sra.frc.soc.2001.ls[[i]])
})
names(sra.frc.soc.01.19.ls) <- names(sra.frc.soc.2019.ls)

# merge mass frc
sra.frc.mss.fill.long.ls <- split(sra.frc.mss.fill.plot.df, sra.frc.mss.fill.plot.df$Fraction)
sra.frc.mss.fill.long.ls <- lapply(sra.frc.mss.fill.long.ls, function(df) {
  df[ , c("PM", "ECO", "year", "lyr_bot", "Mass percent")]
})
sra.frc.soc.ls <- mapply(
  merge,
  sra.frc.soc.01.19.ls,
  sra.frc.mss.fill.long.ls,
  SIMPLIFY = FALSE)

# Calculate C pct of layer, absolute C, stock per fraction
sra.frc.soc.df <- bind_rows(sra.frc.soc.ls, .id = "Fraction")
sra.frc.soc.df$frc_C_lyr <- (sra.frc.soc.df$C * sra.frc.soc.df$`Mass percent`) /
    sra.frc.soc.df$c_pct_lyr
sra.frc.soc.wide.df <- pivot_wider(
  sra.frc.soc.df, 
  id_cols = c("year", "PM", "ECO", "lyr_bot", "c_pct_lyr",), 
  names_from = c("Fraction"), values_from = c("C", "Mass percent", "frc_C_lyr")) %>%
  merge(., sra.frc.mss.wide.fill.df[ , c("PM", "ECO", "lyr_bot", "year", "wt_g")])

# sum gC frc
sra.frc.soc.wide.df$c_pct_lyr_frc <- rowSums(sra.frc.soc.wide.df[, c("frc_C_lyr_FPOM", "frc_C_lyr_OPOM", "frc_C_lyr_MOM")]) * 100
sra.frc.soc.wide.df$C_diff <- sra.frc.soc.wide.df$c_pct_lyr_frc - 100
```

```{r plot-c-loss}
# 2001
# sra.frc.soc.wide.df %>%
#   filter(year == 2001) %>%
#   mutate(PMeco = paste0(PM, ECO)) %>%
#   ggplot(., aes(PMeco, soc_lost)) +
#   geom_col() +
#   facet_grid(rows = vars(lyr_bot)) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank())

# 2019
sra.frc.soc.wide.df %>%
  filter(year == 2019) %>%
  mutate(Site = factor(paste0(PM, ECO), 
                       levels = c("ANpp", "ANwf", "ANrf", 
                                  "BSpp", "BSwf", "BSrf", 
                                  "GRpp", "GRwf", "GRrf")),
         `C dif. (% of total stock)` = C_diff) %>%
  ggplot(., aes(Site, `C dif. (% of total stock)`)) +
  geom_col() +
  facet_grid(rows = vars(lyr_bot)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
```

What is the 14C of the lost/"mobilized" (cf. Gentsch, Mikutta, Alves, et al., 2015; Gentsch, et al., 2018) fraction? Should be able to calculate this by subtraction.

## Fraction 14C
### Depth profiles

```{r shape-dens14C-df}
# function for splitting sample names and extracting values from ams list
uScoreSplit.fx <- function(df, ix) sapply(strsplit(df[["Probe"]], "_"), "[[", ix)

# create df
dens.df <- bind_rows(
  lapply(
    ams_results_ls[-grep("thml", names(ams_results_ls))], function(ls) {
      df.ex <- function(x, frc) {
        bind_rows(lapply(x, function(df) {
          df[grep(frc, df$Probe), 2:6]
        }))
      }
      fPOM <- df.ex(ls, "FPOM")
      oPOM <- df.ex(ls, "OPOM")
      minC <- df.ex(ls, "MOM")
      return(
        cbind(rbind(fPOM, oPOM, minC), frc = c(rep("fPOM", nrow(fPOM)),
                                               rep("oPOM", nrow(oPOM)),
                                               rep("minC", nrow(minC)))))
    })) %>%
  mutate(PMeco = uScoreSplit.fx(., 2),
         PM = substr(PMeco, 1, 2),
         ECO = factor(substr(PMeco, 3, 4), levels = c("pp", "wf", "rf")),
         Year = uScoreSplit.fx(., 4),
         pro_name = paste0(PMeco, "_", Year),
         depths = uScoreSplit.fx(., 5),
         lyr_top = as.numeric(sapply(strsplit(depths, "-"), "[[", 1)),
         lyr_bot = as.numeric(sapply(strsplit(depths, "-"), "[[", 2))) %>%
  rename(frc_14c = "∆14C.(‰)",
         frc_14c_err = "err.(‰)") %>%
  select(-c(Probe, depths)) %>%
  filter(!is.na(frc_14c))

# add '09 data
dens.01.09.19.df <- rbind(
  dens.df, 
  sra.frc.14c %>%
    select(-lyr_bd_samp)) %>%
  mutate(pm = ifelse(PM == "AN", "andesite", 
                     ifelse(PM == "BS", "basalt", "granite")),
         eco = factor(ifelse(ECO == "pp", "warm", ifelse(ECO == "wf", "cool", "cold")),
                      levels = c("warm", "cool", "cold")),
         year = as.numeric(Year),
         middepth = lyr_top + (lyr_bot - lyr_top) / 2)
```

``` {r plot-profiles}
# pro plot fx
dens.pro.p.fx <- function(df, year, leg.pos = "right") {
  
  # filter df by year
  df <- df[df$year == year, ]
  
  # get atm 14C
  atm.14c <- atm.14c[atm.14c$year == year + .5, "d14c"]
  
  # set shape to 2001 defaults
  shp.v <- c("warm" = 15, "cool" = 17, "cold" = 16)
  alf <- 1
  lnt.v <- c("2001" = 1)
  stroke <- 1
  ln.sz <- .5
  
  # change shape and alpha as needed
  if (year == 2009) {
    alf <- .6
    lnt.v <- c("2009" = 2)
  } else if (year == 2019) {
    shp.v <- c("warm" = 0, "cool" = 2, "cold" = 1)
    lnt.v <- c("2019" = 3)
    stroke <- 1.2
    ln.sz <- 1
  }
  
  # plot fx
  ggplot(df, aes(frc_14c, lyr_bot, color = frc)) +
    geom_vline(xintercept = atm.14c, color = "gray") +
    geom_point(aes(shape = eco), size = 3, alpha = alf, stroke = stroke) +
    geom_path(aes(linetype = Year), size = ln.sz) +
    scale_color_manual(name = NULL,
                       values = c("minC" = "#9b003f",
                                  "fPOM" = "#3f9b00",
                                  "oPOM" = "#0047af")) +
    scale_linetype_manual(name = NULL, values = lnt.v) +
    scale_shape_manual(name = NULL, values = shp.v) +
    facet_grid(rows = vars(eco), cols = vars(pm)) +
    scale_y_reverse() +
    theme_bw() +
    theme(panel.grid = element_blank(),
          legend.position = leg.pos)
}

# pro plot fx
dens.pro.p.fx2 <- function(df) {
  
  ggplot(df, aes(frc_14c, middepth, color = pm)) +
    geom_vline(xintercept = 0, linetype = 2) +
    geom_point(aes(shape = eco), size = 3) +
    geom_path() +
    scale_color_manual(name = NULL,
                       values = c("andesite" = andesite,
                                  "basalt" = basalt,
                                  "granite" = granite)) +
    scale_shape_manual(name = NULL, 
                       values = c("warm" = 15,
                                  "cool" = 17,
                                  "cold" = 16)) +
    facet_grid(rows = vars(eco), cols = vars(frc2)) +
    scale_y_reverse(limits = c(30, 0)) +
    theme_bw() +
    ylab("Depth (cm)") +
    xlab(expression('Fraction '*Delta*''^14*' (‰)')) +
    guides(color = guide_legend(ncol = 3),
           shape = guide_legend(ncol = 3)) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          axis.title = element_text(size = 14),
          axis.text = element_text(size = 10),
          strip.text.x = element_text(face = "bold", size = 12),
          strip.text.y = element_text(face = "bold", angle = 0, size = 12),
          strip.background = element_rect(fill = "white", color = "white"),
          legend.position = "bottom",
          legend.text = element_text(size = 12)) 
}
```

```{r plot-dens-pros}
# plot profiles by year and fraction type
dens.pro.p.fx(dens.01.09.19.df, 2001)
dens.pro.p.fx(dens.01.09.19.df, 2019)
dens.pro.p.fx(dens.01.09.19.df, 2009)
      
dens.01.09.19.plot.df <- dens.01.09.19.df %>%
  filter(lyr_bot < 31) %>%
  mutate(frc2 = ifelse(frc == "fPOM", "free light", ifelse(frc == "oPOM", "occluded light", "heavy")))
dens.01.09.19.plot.df <- dens.01.09.19.plot.df[dens.01.09.19.plot.df$frc != "oPOM" & dens.01.09.19.plot.df$year == 2019, ]

dens.pro.p.fx2(dens.01.09.19.plot.df)
```

## Spline '01, '09
### Spline C

```{r spline-c-data}
# spline fit fxs for fraction SOC stocks
## Mass preserving spline (quadratic)
mpspline.frc.fx <- function(frc.df) {
  
  # split by frc and PMeco to fit splines to profiles
  lapply(
    split(frc.df, frc.df$frc), function(df) {
      lapply(split(df, df$PMeco), function(x) {
        
        # check for single obs data
        if (nrow(x) > 1) {
          
          # make sure to order data
          x <- x[order(x$lyr_bot), ] 
          
          # calculate cumulative C mass
          x$mass_c_cmtv <- NA
          for(i in seq_along(x$lyr_bot)) {
            if(i == 1) {
              x$mass_c_cmtv[i] <- x$mass_c_g[i]
            } else {
              x$mass_c_cmtv[i] <- x$mass_c_g[i] + x$mass_c_cmtv[i-1] 
            }
          }
          
          # convert to soil profile collection obj and run mpspline
          depths(x) <- PMeco ~ lyr_top + lyr_bot
          x.mps <- suppressMessages(
            mpspline(x, var.name = "mass_c_cmtv", show.progress = FALSE))
          
          # extract 1 cm increment data
          ix <- which(!is.na(x.mps$var.1cm))
          df <- data.frame(middepth = seq(1, length(ix)),
                           lyr_soc = x.mps$var.1cm[ix])
          
          # check for NA values up to 30 cm
          if (length(ix) < 31) {
            # convert to class "spline" with smooth.spline fxn
            sp.ss <- smooth.spline(df)
          
            # predict for NA values up to 31 cm (linear beyond last measured depth)
            std <- seq(0, 30) # in cm 
            sp <- predict(sp.ss, std) 
            df <- data.frame(sp)
            colnames(df) <- c("middepth","lyr_soc") 
          }
          
          # return
          return(df)
        }
      })
    })
}

## depth spline alternative (linear for two increment fits...)
SOCspline.fx <- function(frc.df) {
  
  # split by frc and PMeco to fit splines to profiles
  lapply(
    split(frc.df, frc.df$frc), function(df) {
      lapply(split(df, df$PMeco), function(x) {
    
        # check for single obs data
        if (nrow(x) > 1) {
          
          # make sure to order data
          x <- x[order(x$lyr_bot), ] 
          
          # calculate cumulative C mass
          x$mass_c_cmtv <- NA
          for(i in seq_along(x$lyr_bot)) {
            if(i == 1) {
              x$mass_c_cmtv[i] <- x$mass_c_g[i]
            } else {
              x$mass_c_cmtv[i] <- x$mass_c_g[i] + x$mass_c_cmtv[i-1] 
            }
          }
          
          # fit monotonic cubic spline
          sp <- spline(x[ , c("middepth", "mass_c_cmtv")], method = "hyman") 
          
          # convert to class "spline" with smooth.spline fxn
          sp.ss <- smooth.spline(sp) 
          
          # predict 1 cm increments to 30 cm (linear beyond last measured depth)
          std <- seq(0, 30) # in cm 
          sp <- predict(sp.ss, std) 
          df <- data.frame(sp)
          colnames(df) <- c("middepth","lyr_soc") 
          
          # return 
          return(df)
        }
      })
    })
}
```

```{r run-cspline-frc}
# fraction C stocks
soc.2009.frcSOC.sp <- mpspline.frc.fx(sra.09.lyr.C)
soc.2001.frcSOC.sp <- mpspline.frc.fx(sra.frc.mss.C.01.df)
soc.2001.frcSOC.sp.df <- lapply(soc.2001.frcSOC.sp, function(ls)
  lapply(ls, function(df) {
    # summarize for target intervals
        df <- data.frame(
          lyr_bot = c(10, 20, 30),
          lyr_soc_cmtv = c(df[10, "lyr_soc"],
                           df[20, "lyr_soc"],
                           df[30, "lyr_soc"]))
        df$lyr_soc <- NA
        for (i in seq_along(df$lyr_bot)) {
          if(i == 1) {
              df$lyr_soc[i] <- df$lyr_soc_cmtv[i]
            } else {
              df$lyr_soc[i] <- df$lyr_soc_cmtv[i] - df$lyr_soc_cmtv[i - 1] 
            }
        }
        
        return(df[ , c("lyr_bot", "lyr_soc")])
  }))

test <- sra.frc.mss.C.01.df %>% 
  SOCspline.fx

# Measured SOC as ls
sra.frc.mss.C.01.ls <- lapply(
  split(sra.frc.mss.C.01.df, sra.frc.mss.C.01.df$frc), function(df)
    split(df, df$PMeco))

# make spline lists similar for plotting together
frc.pmeco.fx <- function(soc_ls, name) {
    lapply(seq_along(soc_ls), function(j)
      lapply(seq_along(soc_ls[[j]]), function(i) {
        PMeco <- names(soc_ls[[j]])[i]
        if (!is.data.frame(soc_ls[[j]][[i]])) {
          lyr_soc <- soc_ls[[j]][[i]]
          df <- data.frame(middepth = seq(1, length(lyr_soc)),
                           lyr_soc = lyr_soc)
        } else {
          df <- soc_ls[[j]][[i]]
        }
        # add name and return
        df %>%
          mutate(id = name,
                 PMeco = PMeco,
                 frc = names(soc_ls)[j])
      }))
  }
  
# run fx
ls1 <- frc.pmeco.fx(test, "sp")
ls2 <- frc.pmeco.fx(soc.2001.frcSOC.sp, "mpspline")
  
# combine lists
ls12 <- lapply(seq_along(ls1), function(i)
  bind_rows(
    lapply(seq_along(ls1[[i]]), function(j)
      rbind(ls1[[i]][[j]], ls2[[i]][[j]])
      ), .id = "PMeco") %>%
    mutate(PMeco = factor(PMeco, labels = unique(sra.frc.mss.C.01.df$PMeco))))

# calculate cumulative C mass
sra.frc.mss.C.01.ls2 <- lapply(sra.frc.mss.C.01.ls, function(ls) {
  lapply(ls, function(df) {
    df$mass_c_cmtv <- NA
    for(i in seq_along(df$lyr_bot)) {
      if(i == 1) {
        df$mass_c_cmtv[i] <- df$mass_c_g[i]
      } else {
        df$mass_c_cmtv[i] <- df$mass_c_g[i] + df$mass_c_cmtv[i - 1] 
      }
    }
    return(df)
  })
})

# add additional 0 measurement for step plot
sra.frc.mss.C.01.ls3 <- lapply(sra.frc.mss.C.01.ls2, function(ls)
  bind_rows(lapply(ls, function(df) {
    x <- df[which(df$lyr_bot == min(df$lyr_bot)), ]
    x$lyr_bot <- 0
    rbind(x, df)
  }))
)

# bind rows of sublist
sra.frc.mss.C.01.ls4 <- lapply(sra.frc.mss.C.01.ls2, function(ls) bind_rows(ls))

# add measured data to df12 and plot
p.ls <- lapply(seq_along(ls12), function(i) {
  frc <- ls12[[i]][["frc"]]
  ls12[[i]] %>%
    mutate(PM = substr(PMeco, 1, 2),
           ECO = substr(PMeco, 3, 4)) %>%
    ggplot(., aes(lyr_soc, middepth, color = PM)) +
    geom_step(data = sra.frc.mss.C.01.ls3[[i]],
              aes(mass_c_cmtv, lyr_bot)) +
    geom_path(aes(linetype = id)) +
    geom_point(data = sra.frc.mss.C.01.ls4[[i]],
               aes(mass_c_cmtv, middepth)) +
    scale_color_manual(values = c("AN" = andesite,
                                  "BS" = basalt,
                                  "GR" = granite)) +      
    scale_y_reverse() +
    facet_grid(cols = vars(PM), rows = vars(ECO)) +
    ggtitle(frc) +
    theme_bw() +
    theme(panel.grid = element_blank())
})

# plot
p.ls
```

```{r combine-fpom-opom}
# combine fPOM and oPOM for "POM" fraction
soc.2001.POM.sp.df <- bind_rows(mapply(
  merge,
  soc.2001.frcSOC.sp.df$FPOM,
  soc.2001.frcSOC.sp.df$OPOM,
  MoreArgs = list(by = "lyr_bot", suffixes = c("_fPOM", "_oPOM")),
  SIMPLIFY = FALSE), .id = "PMeco")
soc.2001.POM.sp.df$soc_POM <- rowSums(
  soc.2001.POM.sp.df[ , c("lyr_soc_fPOM", "lyr_soc_oPOM")])
pom.c.01.df <- pivot_longer(
  soc.2001.POM.sp.df, 
  cols = starts_with("lyr_soc"),
  names_to = "frc",
  names_prefix = "lyr_soc_",
  values_to = "soc_frc")
pom.c.01.df$c_POM_frc <- pom.c.01.df$soc_frc / pom.c.01.df$soc_POM
```

### Spline 14C

```{r spline-14C-frc}
# run mpspline on fraction modern data for '01, '09
dens.01.09.df <- dens.01.09.19.df[which(dens.01.09.19.df$year != 2019), ]
dens.01.09.df$frc <- factor(dens.01.09.df$frc, levels = c("fPOM", "oPOM", "minC"))
dens.01.09.ls.sp <- lapply(
  split(dens.01.09.df, dens.01.09.df$frc), function(df) {
    lapply(split(df, df$pro_name), function(x) {
      if (length(which(!is.na(x$F14C))) > 1) {
       depths(x) <- pro_name ~ lyr_top + lyr_bot
        x.mps <- suppressMessages(
          mpspline(x, var.name = "F14C", show.progress = FALSE))
        x.mps$var.1cm <- x.mps$var.1cm[1:30]
        
        # fill NA w/ smooth.spline prediction (linear)
        ix <- which(is.na(x.mps$var.1cm))
        if (length(ix) > 0) {
          sp.ss <- smooth.spline(x.mps$var.1cm[-ix])
          sp <- predict(sp.ss, ix)
          x.mps$var.1cm[ix] <- sp$y
        }
        return(x.mps) 
      }
    })
  })
dens.01.09.ls.sp <- lapply(dens.01.09.ls.sp, function(ls) {
  names(ls) <- ifelse(grepl("2010", names(ls)), sub("2010", "2009", names(ls)), names(ls))
  return(ls)
})
```

```{r plot-frc-fm-splines}
# plot for determining best extrapolation fx
frc.fm.sp.plot.fx <- function(fm.sp.ls) {
  lapply(fm.sp.ls, function(ls) {
    p <- bind_rows(lapply(seq_along(ls), function(i) {
      if (!is.null(ls[[i]])) {
        df <- data.frame(t(do.call(rbind, list(ls[[i]][[1]], ls[[i]][[4]]))))
        df$middepth <- seq(1, length(df[ , 1]))
        df$PM <- substr(df[ , 1], 1, 2)
        df$ECO <- substr(df[ , 1], 3, 4)
        df$Year <- ifelse(substr(df[ , 1], 6, 9) == "2010", "2009",
                          substr(df[ , 1], 6, 9))
        colnames(df)[2] <- "fm"
        df$fm <- as.numeric(as.character(df$fm))
        return(df[ , -1])
      }
    })) %>%
    ggplot(., aes(fm, middepth, color = PM, linetype = Year)) +
    geom_path() +
    scale_color_manual(name = NULL,
                       values = c("AN" = andesite,
                                  "BS" = basalt,
                                  "GR" = granite)) +
    scale_linetype_manual(name = NULL,
                          values = c("2001" = 1,
                                     "2009" = 2)) +
    scale_x_continuous(limits = c(.75, 1.25)) +
    scale_y_reverse() +
    facet_grid(rows = vars(ECO), cols = vars(PM)) +
    theme_bw() +
    theme(panel.grid = element_blank())
  })
}
dens.01.09.ls.sp.p <- frc.fm.sp.plot.fx(dens.01.09.ls.sp)
```

### C-weighted 14C spline

```{r cwt-14c}
# fractions
cwt.frc.fx <- function(soc.ls) {
  lapply(soc.ls, function(pro_ls) {
    lapply(pro_ls, function(soc) {
      d <- seq(10, 30, 10)
      c <- vector(mode = "list", length = length(d))
      for(j in seq_along(d)) {
        if(j == 1) {
          # first depth increment
          c[[j]] <- soc[1:d[j], "lyr_soc"]
        } else {
          # following depth increments
          c[[j]] <- soc[(d[j-1]+1):d[j], "lyr_soc"] 
        }
      }
      return(unlist(lapply(c, function(x) x / sum(x, na.rm = TRUE))))
    })
  })
}

# 2001
cwt.19.01.frc <- cwt.frc.fx(soc.2001.frcSOC.sp)

# 2009
cwt.19.09.frc <- cwt.frc.fx(soc.2009.frcSOC.sp)

# combine
cwt.19.01.09.frc <- lapply(seq_along(cwt.19.01.frc), function(i) {
  ls.01 <- cwt.19.01.frc[[i]]
  names(ls.01) <- paste0(names(cwt.19.01.frc[[i]]), "_2001")
  ls.09 <- cwt.19.09.frc[[i]]
  names(ls.09) <- paste0(names(cwt.19.09.frc[[i]]), "_2009")
  ls <- c(ls.01, ls.09)
  ls[order(names(ls))]
})
names(cwt.19.01.09.frc) <- names(cwt.19.01.frc)

## calculate fm_wts
## '19 depths
fm.wtd.19.01.09 <- lapply(seq_along(dens.01.09.ls.sp), function(i) {
  
  # run fx on non-null elements
  fm.ls <- lapply(seq_along(dens.01.09.ls.sp[[i]]), function(j) {
    
    if (!is.null(dens.01.09.ls.sp[[i]][[j]])) {
      
      # combine cwt, fm
      df <- data.frame(cwt = cwt.19.01.09.frc[[i]][[j]], 
                       fm = dens.01.09.ls.sp[[i]][[j]][["var.1cm"]])
            
      # calculate wtd fm
      df$fm_wt <- df$cwt * df$fm
      
      # summarize for target intervals
      data.frame(
        lyr_bot = c(10, 20, 30),
        fm = c(
          sum(df[1:10, "fm_wt"]), 
          sum(df[11:20, "fm_wt"]), 
          sum(df[21:30, "fm_wt"]))) 
    }
  })
  
  # restore names
  names(fm.ls) <- names(dens.01.09.ls.sp[[i]])
    
  # return wtd fm list
  return(fm.ls)
})
names(fm.wtd.19.01.09) <- names(dens.01.09.ls.sp)
```

```{r prep-cwt-14c-plot}
# make df for splined '01 data
dens.01.09.df <- bind_rows(
  lapply(fm.wtd.19.01.09, function(ls) 
    bind_rows(ls, .id = "PMeco_year")), .id = "frc") %>%
  mutate(PMeco = substr(PMeco_year, 1, 4),
         pm = ifelse(substr(PMeco_year, 1, 2) == "AN", "andesite", 
                     ifelse(substr(PMeco_year, 1, 2) == "BS", "basalt", "granite")), 
         eco = factor(
           ifelse(substr(PMeco_year, 3, 4) == "pp", "warm", 
                  ifelse(substr(PMeco_year, 3, 4) == "wf", "cool", "cold")),
           levels = c("warm", "cool", "cold")),
         year = ifelse(grepl("2001", PMeco_year), 2001, 2009),
         Year = as.character(year),
         frc_14c = convert_fm_d14c(fm = fm, obs_date_y = year, verbose = FALSE),
         frc = factor(frc, levels = c("fPOM", "oPOM", "minC"))) %>%
  rename(F14C = fm) %>%
  select(-PMeco_year)

# combine '01, '19 data; rm NA
dens.01.09.19.sp.df <- rbind(
  dens.01.09.df,
  dens.01.09.19.df[dens.01.09.19.df$year == 2019 & dens.01.09.19.df$lyr_bot < 31, names(dens.01.09.19.df) %in% names(dens.01.09.df)]) %>%
  filter(!is.na(frc_14c))

# add PMeco_depth col
dens.01.09.19.sp.df$PMeco_depth <- paste0(substr(dens.01.09.19.sp.df$PMeco, 1, 4), "_", dens.01.09.19.sp.df$lyr_bot - 10, "-", dens.01.09.19.sp.df$lyr_bot)

# save
save(dens.01.09.19.sp.df, file = "dens.01.09.19.sp.df.RData")

# plot fc
plot.d14c.ts.fx <- function(df, compare_var) {
  
  # set quo_var
  quo_var <- sym(compare_var)
  
  # set facet var and color scales
  if (compare_var == "pm") {
    f_var <- sym("eco")
    cvals <- c("andesite" = andesite, "basalt" = basalt, "granite" = granite) 
  } else {
    f_var <- sym("pm")
    cvals <- c("warm" = warm, "cool" = cool, "cold" = cold)
  }
  
  # split by depth and plot
  lapply(split(df, df$lyr_bot), function(x) {
    x %>%
      filter(frc != "oPOM") %>%
      mutate(ECO = factor(ifelse(eco == "warm", "WARM", ifelse(eco == "cool", "COOL", "COLD")), levels = c("WARM", "COOL", "COLD")),
        frc = ifelse(frc == "fPOM", "free light", "heavy")) %>%
    ggplot(., aes(year, frc_14c, color = !! quo_var)) +
    geom_line(data = atm.14c, aes(year, d14c), 
              linetype = 3, color = "gray", size = .7) +
    geom_line(size = 1) +
    geom_point(aes(shape = ECO), size = 3) +
    scale_color_manual(name = NULL, values = cvals) +
    scale_shape_manual(name = NULL,
                       values = c("WARM" = 15,
                                  "COOL" = 17,
                                  "COLD" = 16),
                       labels = c("WARM" = "warm",
                                  "COOL" = "cool",
                                  "COLD" = "cold")) +
    scale_x_continuous(breaks = c(2001, 2009, 2019)) +
    facet_grid(rows = vars(frc), cols = vars(!! f_var)) +
    ylab(expression('Fraction '*Delta*''^14*' (‰)')) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 14),
          axis.text = element_text(size = 10),
          strip.text.x = element_text(face = "bold", size = 12),
          strip.text.y = element_text(face = "bold", angle = 0, size = 12),
          strip.background = element_rect(fill = "white", color = "white"),
          legend.position = "bottom",
          legend.text = element_text(size = 12)) 
  })
}
```

### 14C time series

```{r plot-cwt-14c}
# plot
plot.d14c.ts.fx(dens.01.09.19.sp.df, "pm")
plot.d14c.ts.fx(dens.01.09.19.sp.df, "eco")
```

```{r emmip-plot-fx}
# linear mods for TS
mod.fx <- function(frc, lyr_bot) {
  df <- dens.01.09.19.sp.df[dens.01.09.19.sp.df$frc == frc &
                              dens.01.09.19.sp.df$lyr_bot == lyr_bot, ]
  df$year <- df$year - 2000
  lm(frc_14c ~ year * pm * eco, df)
}
mod.ls <- list(
  ts.mod.10.fPOM = mod.fx("fPOM", 10),
  ts.mod.10.minC = mod.fx("minC", 10),
  ts.mod.30.fPOM = mod.fx("fPOM", 30),
  ts.mod.30.minC = mod.fx("minC", 30)
)

 emmip.fx <- function(mod, var) {
   brks <- c(1, 9, 19)
   if (var == "pm") {
     emmip(mod, pm ~ year | eco, CIs = TRUE, at = list(year = brks))$data
   } else {
     emmip(mod, eco ~ year | pm, CIs = TRUE, at = list(year = brks))$data
   }
 }

# return emmip ls
ts.emmip.ls <- lapply(seq_along(mod.ls), function(i) {
  emmip.fx(mod.ls[[i]], "pm") %>%
    mutate(frc = ifelse(i == 1 | 3, "fPOM", "minC"),
           lyr_bot = ifelse(i < 3, 10, 30))
})

# plot fn
plot.fx <- function(ls, data, var) {
  
  # set grouping var
  quo_var <- sym(var)
  
  # set color palette & facet var
  if (var == "pm") {
    cvals <- c("andesite" = andesite, "basalt" = basalt, "granite" = granite)
  } else {
    cvals <- c("warm" = warm, "cool" = cool, "cold" = cold)
  }
  
  # modify point and atm data
  data <- dens.01.09.19.sp.df %>%
    filter(frc != "oPOM") %>%
    mutate(ecoFrc = paste0(eco, " (", frc, ")"),
           year = year - 2000)
  atm.14c$frc <- atm.14c$Type
  
  # run loop
  lapply(seq_along(ls), function(i) {
    
    # get data
    data <- data[which(data$frc == unique(ls[[i]][["frc"]]) &
                         data$lyr_bot == unique(unique(ls[[i]][["lyr_bot"]]))), ]
    
    # get title
    title <- paste(ls[[i]][["frc"]], ls[[i]][["lyr_bot"]])
    
    # plot
    ggplot(ls[[i]], aes(xvar, yvar)) +
      geom_line(aes(color = !! quo_var, linetype = frc), size = .8) +
      geom_ribbon(aes(ymin = LCL, ymax = UCL, fill = !! quo_var, linetype = frc), alpha = .1, show.legend = FALSE) +
      geom_point(data = data,
        aes(year, frc_14c, color = !! quo_var, shape = ecoFrc), size = 1.5, alpha = .8) +
      # atm
      geom_line(data = atm.14c, aes(year, d14c, linetype = frc), color = "black") +
      scale_linetype_manual(name = NULL, 
                            limits = c("minC", "fPOM", "atmosphere"),
                            values = c("minC" = 1,
                                       "fPOM" = 2,
                                       "atmosphere" = 3)) +
      scale_shape_manual(name = NULL,
                         limits = c("warm (minC)", "cool (minC)", "cold (minC)",
                                    "warm (fPOM)", "cool (fPOM)", "cold (fPOM)"),
                         values = c("warm (minC)" = 15, 
                                    "cool (minC)" = 17, 
                                    "cold (minC)" = 16,
                                    "warm (fPOM)" = 0, 
                                    "cool (fPOM)" = 2, 
                                    "cold (fPOM)" = 1)) +  
      scale_color_manual(name = NULL,
                         values = cvals) +
      scale_fill_manual(name = NULL,
                        values = cvals) +
      scale_x_continuous(limits = c(0, 20), 
                         breaks = c(1, 9, 19), 
                         expand = expansion(add = 2),
                         labels = function (x) x + 2000) +
      # coord_cartesian(ylim = c(-110, 170)) +
      facet_grid(rows = vars(eco), cols = vars(pm)) +
      ggtitle(title) +
      theme_bw() +
      theme(panel.grid = element_blank(),
            axis.title = element_blank(),
            axis.text.x = element_text(size = 7),
            strip.background = element_blank(),
            strip.text.x = element_blank(),
            plot.margin = unit(rep(0, 4), "cm"),
            legend.position = "none")
  })
}

ts.plot.ls <- plot.fx(ls = ts.emmip.ls, data = dens.01.09.19.sp.df, var = "pm")

emtrends(lm(frc_14c ~ year * PMeco, dens.01.09.19.sp.df[dens.01.09.19.sp.df$lyr_bot == "10" & dens.01.09.19.sp.df$frc == "fPOM", ]), pairwise ~ PMeco, var = "year")
```

```{r ts-stats}
dens.01.09.19.sp.df$year_i <- dens.01.09.19.sp.df$year - 2000

# fPOM
fPOM.ts.mod.10 <- lm(frc_14c ~ year_i * pm * eco, 
                     dens.01.09.19.sp.df[dens.01.09.19.sp.df$frc == "fPOM" &
                                           dens.01.09.19.sp.df$lyr_bot == 10, ])
fPOM.ts.mod.20 <- lm(frc_14c ~ year_i * pm * eco, 
                     dens.01.09.19.sp.df[dens.01.09.19.sp.df$frc == "fPOM" &
                                           dens.01.09.19.sp.df$lyr_bot == 20, ])
fPOM.ts.mod.30 <- lm(frc_14c ~ year_i * pm * eco, 
                     dens.01.09.19.sp.df[dens.01.09.19.sp.df$frc == "fPOM" &
                                           dens.01.09.19.sp.df$lyr_bot == 30, ])
summary(fPOM.ts.mod.10)
summary(fPOM.ts.mod.20)
summary(fPOM.ts.mod.30) # all ns

# minC
minC.ts.mod.10 <- lm(frc_14c ~ year_i * pm * eco, 
                     dens.01.09.19.sp.df[dens.01.09.19.sp.df$frc == "minC" &
                                           dens.01.09.19.sp.df$lyr_bot == 10, ])
minC.ts.mod.20 <- lm(frc_14c ~ year_i * pm * eco, 
                     dens.01.09.19.sp.df[dens.01.09.19.sp.df$frc == "minC" &
                                           dens.01.09.19.sp.df$lyr_bot == 20, ])
minC.ts.mod.30 <- lm(frc_14c ~ year_i * pm * eco, 
                     dens.01.09.19.sp.df[dens.01.09.19.sp.df$frc == "minC" &
                                           dens.01.09.19.sp.df$lyr_bot == 30, ])
summary(minC.ts.mod.10)
summary(minC.ts.mod.20)
summary(minC.ts.mod.30) # most interesting

fPOM.ts.mod.10.em <- emmeans(fPOM.ts.mod.10, pairwise ~ pm | eco)
fPOM.ts.mod.10.emip <- emtrends(fPOM.ts.mod.10, pairwise ~ pm * eco, var = "year_i")

fPOM.ts.mod.20.em <- emmeans(fPOM.ts.mod.20, pairwise ~ pm | eco)
fPOM.ts.mod.20.emip <- emtrends(fPOM.ts.mod.20, pairwise ~ pm * eco, var = "year_i") 

minC.ts.mod.10.em <- emmeans(minC.ts.mod.10, pairwise ~ pm | eco)
minC.ts.mod.10.emip <- emtrends(minC.ts.mod.10, pairwise ~ pm * eco, var = "year_i")

minC.ts.mod.20.em <- emmeans(minC.ts.mod.20, pairwise ~ pm | eco)
minC.ts.mod.20.emip <- emtrends(minC.ts.mod.20, pairwise ~ pm * eco, var = "year_i")

minC.ts.mod.30.em <- emmeans(minC.ts.mod.30, pairwise ~ pm | eco)
minC.ts.mod.30.emip <- emtrends(minC.ts.mod.30, pairwise ~ pm * eco, var = "year_i")
```

### Char pool calc

```{r pom-minC-14c}
# Koarashi char equation
char.fx <- function(pom_14c) {
  (pom_14c - 149.9) / -7.278 
}

# make df of pom + minC, calculate char C using Koarashi data
pom.c.14c.01.df <- merge(
  pom.c.01.df,
  dens.01.09.19.sp.df %>%
    filter(year == 2001),
  by = c("PMeco", "frc", "lyr_bot")) %>%
  mutate(wtd_14c = c_POM_frc * frc_14c) %>%
  group_by(PMeco, pm, eco, lyr_bot, soc_POM, year) %>%
  summarize(pom_14c = sum(wtd_14c))
pom.c.14c.01.df <- pom.c.14c.01.df %>%
  mutate(c_pct_char = char.fx(pom_14c),
         soc_char = c_pct_char * soc_POM * 10^-2,
         soc_nonChar = soc_POM - soc_char,
         d14c_char = -577.9,
         d14c_nonChar = (pom_14c - d14c_char * c_pct_char) / (100 - c_pct_char))
# ggplot(pom.c.14c.01.df, aes(eco, d14c_nonChar, fill = pm)) +
#   geom_col(position = "dodge") +
#   scale_fill_manual(values = c("andesite" = andesite,
#                                "basalt" = basalt,
#                                "granite" = granite)) +
#   facet_grid(rows = vars(lyr_bot)) +
#   theme_bw() +
#   theme(panel.grid = element_blank())

# # calc. char for oPOM only
# opom.c.14c.01.df <- merge(
#   bind_rows(soc.2001.frcSOC.sp.df$OPOM, .id = "PMeco") %>%
#     mutate(frc = "oPOM"),
#   dens.01.19.df %>%
#     filter(year == 2001),
#   by = c("PMeco", "frc", "lyr_bot")) %>%
#   mutate(c_pct_char = char.fx(frc_14c),
#          soc_char = c_pct_char * lyr_soc * 10^-2,
#          soc_nonChar = lyr_soc - soc_char,
#          d14c_char = -577.9,
#          d14c_nonChar = (frc_14c - d14c_char * c_pct_char) / (100 - c_pct_char))
# ggplot(opom.c.14c.01.df, aes(eco, c_pct_char, fill = pm)) +
#   geom_col(position = "dodge") +
#   scale_fill_manual(values = c("andesite" = andesite,
#                                "basalt" = basalt,
#                                "granite" = granite)) +
#   facet_grid(rows = vars(lyr_bot)) +
#   theme_bw() +
#   theme(panel.grid = element_blank())
```

### Fraction vs respired 14C

```{r plot-LF-inc}
# load data
load("/Users/jeff/sra-ts/source/sra.all.min.RData")
load("/Users/jeff/sra-ts/source/sra.inc.all.RData") # original depths
load("/Users/jeff/sra-ts/source/sra.19.01.inc.RData") # splined
load("/Users/jeff/sra-ts/source/sra.2001.inc.ls.RData") # reps '01
load("/Users/jeff/sra-ts/source/sra.2019.inc.ls.RData") # reps '19

# convert dens.df to wide
dens.01.19.df.w <- dens.01.09.19.df %>%
  select(PMeco, Year, frc, lyr_bot, frc_14c) %>%
  pivot_wider(names_from = frc, values_from = frc_14c)
dens.inc.min.w <- merge(
  sra.inc.all %>%
    filter(d14c_mean > -70),
  dens.01.19.df.w %>%
    mutate(pm = ifelse(grepl("AN", PMeco), "andesite", 
                       ifelse(grepl("BS", PMeco), "basalt", "granite")),
           eco = ifelse(grepl("pp", PMeco), "warm", 
                        ifelse(grepl("wf", PMeco), "cool", "cold"))))

# depth index fx
depth.ix.fx <- function(df, split_var_a = "Year", split_var_b = "PMeco") {
  bind_rows(
    lapply(split(df, df[[split_var_a]]), function(x) 
      bind_rows(lapply(split(x, x[[split_var_b]]), function(y) {
        if (is.null(y$depth)) {
          y[order(y$lyr_bot), ] %>%
            mutate(depth = seq(1, nrow(y))) 
        }
      }))
      )
    )
}

# make reps df
dens.inc.reps.w <- merge(
  bind_rows(
    mapply(rbind, 
           sra.2019.inc.ls,
           sra.2001.inc.ls,
           SIMPLIFY = FALSE)),
  dens.01.19.df.w %>%
    filter(Year != 2009)) %>%
  mutate(pm = ifelse(grepl("AN", PMeco), "andesite", 
                       ifelse(grepl("BS", PMeco), "basalt", "granite")),
         eco = ifelse(grepl("pp", PMeco), "warm", 
                        ifelse(grepl("wf", PMeco), "cool", "cold")),
         year = factor(Year)) %>%
  filter(d14c > -70)
dens.inc.reps.w <- bind_rows(
  lapply(split(dens.inc.reps.w, dens.inc.reps.w$Year), function(x) depth.ix.fx(x, split_var_a = "rep")))

# add depth index col
dens.inc.min.w <- depth.ix.fx(dens.inc.min.w)

# plot inc v LF
# plot profiles by year and fraction type
inc.plot.fx <- function(dens.inc.df, frc) {
  
  quo_var <- sym(frc)
  ylab <- ifelse(frc == "fPOM", expression('free light C '*Delta*''^14*'C (‰)'), 
                 ifelse(frc == "oPOM", 
                        expression('occluded light C '*Delta*''^14*'C (‰)'),
                        expression('min-assoc. C '*Delta*''^14*'C (‰)')))
  dens.inc.df %>%
    filter(d14c_mean > -70) %>%
    ggplot(., aes(d14c_mean, !! quo_var, color = pm, shape = eco)) +
    geom_vline(xintercept = 0, color = "lightgray") +
    geom_hline(yintercept = 0, color = "lightgray") +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmax = d14c_u, xmin = d14c_l), height = 1) +
    scale_color_manual(name = "Parent material",
                       values = c("andesite" = andesite,
                                  "basalt" = basalt,
                                  "granite" = granite)) +
    scale_shape_manual(name = "Climate",
                       values = c("warm" = 15,
                                  "cool" = 17,
                                  "cold" = 16)) +
    # coord_cartesian(xlim = c(-120, 110), ylim = c(-120, 110)) +
    facet_grid(cols = vars(depth), rows = vars(Year)) + 
    xlab(expression(Delta*''^14*'C-CO'[2]*' (‰)')) +
    ylab(ylab) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          aspect.ratio = 1)
}

# plot respired against nonChar; splined data; '01 only
dens.inc.nonChar.df <- merge(
  pom.c.14c.01.df[ , c("PMeco", "pm", "eco", "lyr_bot", "year", "d14c_nonChar")],
  sra.19.01.inc[ , which(!(names(sra.19.01.inc) %in% c("PM", "ECO")))])
  
dens.inc.nonChar.df %>%
  filter(d14c > -70) %>%
  ggplot(., aes(d14c, d14c_nonChar, color = pm)) +
  geom_vline(xintercept = 0, color = "lightgray") +
  geom_hline(yintercept = 0, color = "lightgray") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_point(aes(shape = eco), size = 3) +
  geom_errorbarh(aes(xmin = d14c_min, xmax = d14c_max)) +
  scale_color_manual(name = "Parent material",
                     values = c("andesite" = andesite,
                                "basalt" = basalt,
                                "granite" = granite)) +
  scale_shape_manual(name = "Climate",
                     values = c("warm" = 15,
                                "cool" = 17,
                                "cold" = 16)) +
  facet_grid(cols = vars(lyr_bot)) +
  xlab(expression(Delta*''^14*'C-CO'[2]*' (‰)')) +
  ylab(expression('non-char '*Delta*''^14*'C (‰)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        aspect.ratio = 1)
```

```{r plot-inc-dens}
inc.plot.fx(dens.inc.min.w, "fPOM") 
inc.plot.fx(dens.inc.min.w, "oPOM")
inc.plot.fx(dens.inc.min.w, "minC")
```

```{r stats-frc-resp}
fPOM.resp.mod <- lm(fPOM ~ d14c * pm * eco, dens.inc.reps.w)
minC.resp.mod <- lm(minC ~ d14c * pm * eco + year, dens.inc.reps.w)
minC.resp.mod.01 <- lm(minC ~ d14c * pm * eco, 
                       dens.inc.reps.w[dens.inc.reps.w$Year == "2001", ])
minC.resp.mod.19 <- lm(minC ~ d14c * pm * eco, 
                       dens.inc.reps.w[dens.inc.reps.w$Year == "2019", ])

summary(fPOM.resp.mod)
summary(minC.resp.mod)

fPOM.resp.em.PMeco <- emmeans(fPOM.resp.mod, pairwise ~ pm | eco)
fPOM.resp.em.ECOpm <- emmeans(fPOM.resp.mod, pairwise ~ eco | pm)
fPOM.resp.emip.eco <- emtrends(fPOM.resp.mod, pairwise ~ eco, var = "d14c") # ns
fPOM.resp.emip.pm <- emtrends(fPOM.resp.mod, pairwise ~ pm, var = "d14c") # ns

minC.resp.em.PMeco <- emmeans(minC.resp.mod, pairwise ~ pm | eco)
minC.resp.em.ECOpm <- emmeans(minC.resp.mod, pairwise ~ eco | pm)
minC.resp.emip.eco <- emtrends(minC.resp.mod, pairwise ~ eco, var = "d14c") 
# cold - warm p = 0.0176, est dif = -.44
minC.resp.emip.pm <- emtrends(minC.resp.mod, pairwise ~ pm, var = "d14c") # ns
```

```{r frc-resp-plots-egu}
# plot fx
dens.inc.plot.fx <- function(df, var, d14c_var, f_var_c = NA, f_var_r = NA, frc_filter = NA, smooth = FALSE, by_group = TRUE) {
  
  # quote vars
  quo_var <- sym(var)
  quo_d14c_var <- sym(d14c_var)
  
  # mutate df
  df <- df %>%
    select(!oPOM) %>%
    pivot_longer(cols = c(fPOM, minC), names_to = "frc", values_to = "frc_14c") %>%
    mutate(frc = ifelse(frc == "fPOM", "free light", "heavy"),
           ecoFrc = paste0(eco, " (", frc, ")"))
  
  # set colors
  if (var == "pm") {
    col_name <- "Parent material"
    cvals <- c("andesite" = andesite, "basalt" = basalt, "granite" = granite) 
  } else {
    col_name <- "Climate"
    cvals <- c("warm" = warm, "cool" = cool, "cold" = cold)
  }
  
  # frc filter
  if (!is.na(frc_filter)) {
    df <- df %>%
      filter(frc == frc_filter)
    if (frc_filter == "free light") {
      shp_vals <- c("warm (free light)" = 0,
                   "cool (free light)" = 2,
                   "cold (free light)" = 1)
    } else {
      shp_vals <- c("warm (heavy)" = 15,
                   "cool (heavy)" = 17,
                   "cold (heavy)" = 16)
    }
  }
  
  if (by_group) {
    p <- ggplot(df, aes(!! quo_d14c_var, frc_14c, color = !! quo_var)) 
  } else {
    p <- ggplot(df, aes(!! quo_d14c_var, frc_14c)) 
  }
  p <- p +
    geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
    scale_color_manual(name = col_name,
                       values = cvals) +
    scale_shape_manual(name = "Climate (fraction)",
                       values = shp_vals) +
    scale_size(name = "Depth",
               breaks = c(2, 3, 4),
               range = c(2, 4),
               labels = c("1", "2", "3")) +
    # coord_cartesian(xlim = c(-140, 190), ylim = c(-140, 190)) +
    ylab(expression('Fraction '*Delta*''^14*' (‰)')) +
    xlab(expression('Respired '*Delta*''^14*'C-CO'[2]*' (‰)')) +
    guides(size = "none",
           shape = guide_legend(override.aes = list(size = 3))) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          aspect.ratio = 1,
          axis.title = element_text(size = 14),
          axis.text = element_text(size = 12),
          strip.text.x = element_text(face = "bold", size = 12),
          strip.text.y = element_text(face = "bold", angle = 0, size = 12),
          strip.background = element_rect(fill = "white", color = "white"),
          legend.text = element_text(size = 12))
  
  if (!is.na(frc_filter)) {
    p + ggtitle(frc_filter)
  }
  
  if (!is.na(f_var_c)) {
    quo_f_var_c <- sym(f_var_c)
    if (is.na(f_var_r)) {
      p <- p + facet_grid(cols = vars(!! quo_f_var_c))
    } else {
      quo_f_var_r <- sym(f_var_r)
      p <- p + facet_grid(cols = vars(!! quo_f_var_c), rows = vars(!! quo_f_var_r)) 
    }
  }
  
  if (smooth) {
    if (by_group) {
      p <- p + 
        geom_smooth(method = lm, formula = y ~ x, se = FALSE, size = 1.2)
    } else {
      p <- p + 
        geom_smooth(method = lm, formula = y ~ x, se = FALSE, size = 1.2, 
                    color = "black")
    }
    p <- p +
      geom_point(aes(shape = ecoFrc, size = depth, color = !! quo_var), alpha = .3)
      if (d14c_var == "d14c_mean") {
        p <- p + 
          geom_errorbarh(aes(xmax = d14c_u, xmin = d14c_l, color = !! quo_var), 
                         height = 1, alpha = .3)
      }
    p +
      guides(shape = guide_legend(override.aes = list(size = 3, alpha = 1)))
  } else {
    p <- p +
      geom_point(aes(shape = ecoFrc, size = depth, color = !! quo_var))
    if (d14c_var == "d14c_mean") {
      p <- p +
        geom_errorbarh(aes(xmax = d14c_u, xmin = d14c_l, color = !! quo_var), 
                       height = 1, alpha = .3)
    }
    p
  }
}
```

```{r plot-frc-inc-egu}
dens.inc.plot.fx(df = dens.inc.min.w, var = "pm", d14c_var = "d14c_mean", frc_filter = "free light")
# dens.inc.plot.fx(df = dens.inc.min.w, var = "pm", d14c_var = "d14c_mean", frc_filter = "free light", smooth = T, by_group = F)
dens.inc.plot.fx(df = dens.inc.min.w, var = "pm", d14c_var = "d14c_mean", frc_filter = "free light", smooth = T, by_group = T)
dens.inc.plot.fx(df = dens.inc.min.w, var = "pm", d14c_var = "d14c_mean", frc_filter = "heavy")
dens.inc.plot.fx(df = dens.inc.min.w, var = "pm", d14c_var = "d14c_mean", frc_filter = "heavy", smooth = T)
dens.inc.plot.fx(df = dens.inc.min.w, var = "eco", d14c_var = "d14c_mean", frc_filter = "heavy", smooth = T)
dens.inc.plot.fx(df = dens.inc.min.w, var = "eco", d14c_var = "d14c_mean", frc_filter = "free light", smooth = T)
```

## Thermal fractions
### C release (thermograms)
```{r thermal-data}
# load thermogram data and combine
ANwf.30.HF_tml <- read.csv("../data/external/sra_thml_14C_stoner/smooth_ANwf MOM_RPO.csv")
BSwf.30.HF_tml <- read.csv("../data/external/sra_thml_14C_stoner/smooth_BSwf 20-30 Frac fix.csv")
GRwf.30.HF_tml <- read.csv("../data/external/sra_thml_14C_stoner/smooth_GRwf MOM_RPO.csv")
HF_tml.df <- cbind(rbind(ANwf.30.HF_tml, BSwf.30.HF_tml, GRwf.30.HF_tml), 
                   site = c(rep("ANwf", nrow(ANwf.30.HF_tml)), 
                            rep("BSwf", nrow(BSwf.30.HF_tml)), 
                            rep("GRwf", nrow(GRwf.30.HF_tml))))
HF_tml.df$PM <- substr(HF_tml.df$site, 1, 2)

# temp cuts df
HF_tml.temps.df <- data.frame(
  PM = rep(c("AN", "BS", "GR"), ea = 5),
  cut = rep(1:5, 3),
  temp = c(140, 245, 340, 390, 495,
           141.5, 246.5, 290, 364, 484,
           143, 248, 293, 367, 487)
)

# plot
ggplot(HF_tml.df, aes(temp, Moving, color = PM)) +
  # geom_vline(aes(xintercept = temp, color = PM),
  #            data = HF_tml.temps.df,
  #            linetype = "dashed", alpha = .5, show.legend = FALSE) +
  geom_line() +
  scale_color_manual(values = c("AN" = andesite,
                                "BS" = basalt,
                                "GR" = granite)) +
  theme_bw() +
  theme(panel.grid = element_blank())
```

### Thermal fraction 14C

```{r tml-14c}
# wrangle 14C data to df
frc.14c.df <- bind_rows(ams_results_ls$`ams_jena_results-frc19-MOM-thml_2022-01-20`) %>% 
  dplyr::slice(1:15) %>%
  mutate(PM = substr(Probe, 1, 2),
         ECO = "wf", 
         thml_frc = as.numeric(substr(Probe, nchar(Probe), nchar(Probe)))) %>%
  # fix Shane's mislabeling of 14C data
  mutate(PM = ifelse(PM == "AN", "GR", ifelse(PM == "GR", "AN", PM))) %>%
  rename(fm = F14C, fm_err = err, d14c = `∆14C.(‰)`, d14c_err = `err.(‰)`) %>%
  select(PM, ECO, thml_frc, d14c, d14c_err, fm, fm_err)

# save
save(frc.14c.df, file = "frc.14c.df.RData")

# plot
ggplot(frc.14c.df, aes(thml_frc, d14c, fill = PM)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("AN" = andesite,
                               "BS" = basalt,
                               "GR" = granite)) + 
  facet_grid(rows = vars(PM)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank())

# step plot
frc.14c.df %>%
  filter(thml_frc == 5) %>%
  mutate(thml_frc = 6) %>%
  rbind(frc.14c.df, .) %>%
  ggplot(., aes(thml_frc, d14c, color = PM)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_step() +
  scale_color_manual(name = NULL,
                     values = c("AN" = andesite,
                                "BS" = basalt,
                                "GR" = granite),
                     labels = c("AN" = "andesite",
                                "BS" = "basalt",
                                "GR" = "granite")) +
  scale_x_continuous(breaks = seq(1.5, 5.5), labels = as.character(seq(1, 5))) +
  ylab(expression(Delta*''^14*'C (‰)')) +
  xlab("Thermal fraction") +
  theme_bw() +
  theme(panel.grid = element_blank())
```

```{r tml-frc-c}
csv.dir <- "../data/external/sra_thml_14C_stoner"
nms <- list.files(path = csv.dir, pattern = "*.csv")
nms_smooth <- nms[which(grepl("smooth", nms))]
csvlist <- lapply(seq_along(nms_smooth), function(i) {
  read.csv(paste(csv.dir, nms_smooth[i], sep = "/"))
})
names(csvlist) <- sapply(nms_smooth, substr, start = 8, stop = 11, USE.NAMES = FALSE)
# frc.fx <- function(dat, temps_in) {
#   dat <- dat %>%
#     filter(!is.na(CO2_scaled) | !is.na(temp)) %>%
#     select(temp, CO2_scaled) %>%
#     rename(Temp_av = temp,
#            CO2_av = CO2_scaled)
#   
#   # fit spline
#   # set knots
#   maxtemp <- max(dat$Temp_av)
#   temps <- c(temps_in, maxtemp) #To establish upper limit
#   
#   # define spline
#   sp_fun <- splinefun(dat$Temp_av, dat$CO2_av, method = 'fmm')
#   tol <- 1.5e-4 * 2
#   arealist <- list()
#   l <- 1
#   u <- 1
#   
#   # run spline
#   for (i in temps) {
#     if (u == 1){
#       lower <- 100
#       upper <- temps[u]
#       u <- u+1
#     } else {
#       lower <- temps[l]
#       upper <- temps[u]
#       u <- u + 1
#       l <- l + 1
#     }
#     
#     # calc area
#     area <- integrate(sp_fun, lower, upper, subdivisions = 8000, rel.tol = tol)
#     arealist <- c(arealist, area[1])
#   }
#   
#   ### CO2 - modelled fit
#   area_un <- unlist(arealist)
#   totalarea <- integrate(sp_fun, 80, maxtemp, subdivisions = 8000, rel.tol = tol)[1]
#   totalarea_int <- as.numeric(unlist(totalarea))
#   
#   #Calculate total area the right way
#   fractions <- c()
#   for (y in 1:length(temps)) {
#     thistemp <- temps[y]
#     CO2area <- 0
#     if (y == 1) {
#       CO2area_int <- integrate(sp_fun, 80, temps[y], subdivisions = 10000, rel.tol = tol)[1]
#       CO2area <- as.numeric(unlist(CO2area_int))
#       fracproportion <- CO2area / totalarea_int
#       fractions <- c(fractions, fracproportion)
#     } else {
#       templower <- temps[y-1]
#       CO2area_int <- integrate(sp_fun, templower, temps[y], subdivisions = 8000, rel.tol = tol)[1]
#       CO2area <- as.numeric(unlist(CO2area_int))
#       fracproportion <- CO2area / totalarea_int
#       fractions <- c(fractions, fracproportion)
#     }
#   }
#   data.frame(temp_u = temps, c_pct = fractions * 100)
# }
# cfrc.ls <- lapply(seq_along(csvlist), function(i) {
#   frc.fx(csvlist[[i]], 
#          HF_tml.temps.df[grep(substr(names(csvlist)[i], 1, 2), HF_tml.temps.df$PM), "temp"])
# })
# names(cfrc.ls) <- names(csvlist)
# 
# # get C content
# lapply(seq_along(cfrc.ls), function(i) {
#   if (i == 1) {
#     sum(cfrc.ls[[i]][["c_pct"]][5], cfrc.ls[[i]][["c_pct"]][6])
#   } else {
#     cfrc.ls[[i]][["c_pct"]][6]
#   }
# })

# use Shane's functions
source("./utilities/FractionSizes.R")

ANwf.tml.c.dist <- FractionSizes(
  csv = ANwf.30.HF_tml, 
  temps_in = HF_tml.temps.df[HF_tml.temps.df$PM == "AN", "temp"])
BSwf.tml.c.dist <- FractionSizes(
  csv = BSwf.30.HF_tml, 
  temps_in = HF_tml.temps.df[HF_tml.temps.df$PM == "BS", "temp"])
GRwf.tml.c.dist <- FractionSizes(
  csv = GRwf.30.HF_tml, 
  temps_in = HF_tml.temps.df[HF_tml.temps.df$PM == "GR", "temp"])

FmDist.fx <- function(sample, ramp, FmTemp, bulkFm) {
  
  # get length
  len_ramp <- which(ramp$temp == 775)

  ## Grab only relevant data with new RPO smoothing outputs
  ramp <- ramp[1:len_ramp, ]
  ramp$CO2_prop = ramp$Moving / max(ramp$Moving, na.rm = TRUE)

  ## Thermogram
  # Temperature ramp, with intervals for interpolation = reso (default = 0.1)
  ht <- seq(100, 775, by = .1)
  rsp <- spline(ramp$temp, ramp$CO2_prop, xout = ht)
  
  ## Calculate total area under curve
  totAUC <- AUC(ht, rsp$y, method = 'spline', subdivisions = length(ht))
  
  # loop
  Area <- ht
  n <- 1
  cond <- c(rep(TRUE, length(ht) - 1), FALSE)
  for (t in ht) {
    if (cond[n]) {
      Area[n] <- AUC(ht, rsp$y, from = t, to = ht[n + 1], method = 'spline') / totAUC
    } else {
      Area[n] <- AUC(ht, rsp$y, from = t, to = ht[n], method = 'spline') / totAUC
    }
    
    # update counter
    n <- n + 1
  }
  
  # get natural cubic spline fit
  fm_sp_nCub <- spline(y = bulkFm, x = FmTemp, method = 'natural', xout = ht)
  
  # Create data frame with natural cubic spline fit
  df_sp <- data.frame(temp = ht, area = Area, fm_sp_nCub = fm_sp_nCub$y)
  
  # spline fit stats
  NCubstats <- c(
    wqntl = Hmisc::wtd.quantile(
      df_sp$fm_sp_nCub, 
      weights = df_sp$area,
      normwt = TRUE, 
      probs = c(0.1, 0.25, 0.5, 0.75, 0.9)),
    wmean = Hmisc::wtd.mean(
      df_sp$fm_sp_nCub, 
      weight = df_sp$area))

  # get his
  NCubHist <- plotrix::weighted.hist(
    df_sp$fm_sp_nCub, 
    df_sp$area, 
    freq = FALSE,
    main = 'Natural Cubic Spline, Weighted', 
    breaks = seq(from = min(df_sp$fm_sp_nCub), to = max(df_sp$fm_sp_nCub), length.out = 1000), 
    plot = FALSE)
  
  # return
  list(stats = data.frame(sample, NCubstats),
       density = data.frame(sample, 
                            MidFm = seq(from = 0.0, to = 2, length.out = 1000),
                            NCub = c(0, NCubHist$density),
                            NCubDens = density(NCubHist$density, n = 1000)$y),
       area = data.frame(area = df_sp$area, 
                         NCub_Fm = df_sp$fm_sp_nCub,
                         NCub_14c = convert_fm_d14c(fm = df_sp$fm_sp_nCub,
                                                    obs_date_y = 2019, 
                                                    verbose = FALSE)))
}

ANwf.tml.fm.dist <- FmDist.fx(
  "ANwf", 
  ramp = ANwf.30.HF_tml, 
  FmTemp = ANwf.tml.c.dist[[1]][["50th-Temp"]][2:6],
  bulkFm = frc.14c.df[frc.14c.df$PM == "AN", "fm"])

BSwf.tml.fm.dist <- FmDist.fx(
  "BSwf", 
  ramp = BSwf.30.HF_tml, 
  FmTemp = BSwf.tml.c.dist[[1]][["50th-Temp"]][2:6],
  bulkFm = frc.14c.df[frc.14c.df$PM == "BS", "fm"])

GRwf.tml.fm.dist <- FmDist.fx(
  "GRwf", 
  ramp = GRwf.30.HF_tml, 
  FmTemp = GRwf.tml.c.dist[[1]][["50th-Temp"]][2:6],
  bulkFm = frc.14c.df[frc.14c.df$PM == "GR", "fm"])

# combine and plot
xlim <- convert_fm_d14c(
  fm = c(min(ANwf.tml.fm.dist$stats$NCubstats,
             BSwf.tml.fm.dist$stats$NCubstats,
             GRwf.tml.fm.dist$stats$NCubstats) - .04,
         max(ANwf.tml.fm.dist$stats$NCubstats,
             BSwf.tml.fm.dist$stats$NCubstats,
            GRwf.tml.fm.dist$stats$NCubstats) + .04),
  obs_date_y = 2019, verbose = FALSE)
p.tml <- rbind(
  data.frame(PM = "andesite", ANwf.tml.fm.dist$area),
  data.frame(PM = "basalt", BSwf.tml.fm.dist$area),
  data.frame(PM = "granite", GRwf.tml.fm.dist$area)) %>%
  ggplot(.) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_density(aes(x = NCub_14c, y = ..density.., weight = abs(area), 
                   fill = PM, color = PM), alpha = .6) +
  scale_color_manual(name = "Parent material",
                     values = c("andesite" = andesite,
                                "basalt" = basalt,
                                "granite" = granite)) +
  scale_fill_manual(name = "Parent material",
                    values = c("andesite" = andesite,
                               "basalt" = basalt,
                               "granite" = granite)) +
  xlim(xlim) +
  xlab(expression('C-weighted '*Delta*''^14*'C (‰)')) + 
  theme_bw() +
  theme(panel.grid = element_blank())

options(bitmapType = "cairo")
p.tml2 <- rbind(
  data.frame(PM = "andesite", ANwf.tml.fm.dist$area),
  data.frame(PM = "basalt", BSwf.tml.fm.dist$area),
  data.frame(PM = "granite", GRwf.tml.fm.dist$area)) %>%
  ggplot(.) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_density(aes(x = NCub_14c, y = ..density.., weight = abs(area), 
                   fill = PM, color = PM), alpha = .6) +
  scale_color_manual(name = "",
                     values = c("andesite" = andesite,
                                "basalt" = basalt,
                                "granite" = granite)) +
  scale_fill_manual(name = "",
                    values = c("andesite" = andesite,
                               "basalt" = basalt,
                               "granite" = granite)) +
  xlim(xlim) +
  xlab(expression('C-weighted '*Delta*''^14*'C (‰)')) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(size = 24),
        axis.title.x = element_text(size = 28),
        axis.title.y = element_text(size = 28),
        axis.text.y = element_text(size = 24),
        legend.text = element_text(size = 24),
        legend.position = "bottom")
ggsave(filename = "/Users/jeff/nextCloud/Documents/Posters and talks/My posters:talks/IMPRS_Retreat_2022/tml_14c.png", 
       plot = p.tml2, height = 6.61, width = 12.28, units = "in")
p.tml2
```
